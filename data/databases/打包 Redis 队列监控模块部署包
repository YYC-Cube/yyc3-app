# æ‰“åŒ… Redis é˜Ÿåˆ—ç›‘æ§æ¨¡å—éƒ¨ç½²åŒ…
# Creating ZIP package for Redis queue monitoring module for email service
import os
import zipfile

# Define file structure and contents
base_dir = "/mnt/data/email/monitor"
os.makedirs(base_dir, exist_ok=True)

files = {
    "redisQueueExporter.js": """const express = require('express');
const Redis = require('ioredis');
const app = express();
const redis = new Redis();

app.get('/metrics', async (req, res) => {
  const length = await redis.llen('queue:email');
  res.set('Content-Type', 'text/plain');
  res.send(`# HELP email_queue_length å½“å‰é‚®ä»¶é˜Ÿåˆ—é•¿åº¦\\n# TYPE email_queue_length gauge\\nemail_queue_length ${length}`);
});

app.listen(9100, () => {
  console.log('âœ… Prometheus exporter running on port 9100');
});
""",
    "prometheus-alert-rules.yml": """groups:
  - name: email-queue-alerts
    rules:
      - alert: EmailQueueTooLong
        expr: email_queue_length > 100
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "é‚®ä»¶é˜Ÿåˆ—é•¿åº¦è¶…è¿‡é˜ˆå€¼"
          description: "å½“å‰é˜Ÿåˆ—é•¿åº¦ä¸º {{ $value }}ï¼Œå¯èƒ½å­˜åœ¨æ¶ˆè´¹é˜»å¡"
""",
    "grafana-dashboard.json": """{
  "title": "Email Queue Dashboard",
  "panels": [
    {
      "type": "graph",
      "title": "é‚®ä»¶é˜Ÿåˆ—é•¿åº¦",
      "targets": [
        {
          "expr": "email_queue_length",
          "legendFormat": "é˜Ÿåˆ—é•¿åº¦"
        }
      ]
    }
  ]
}
"""
}

# Write files
for filename, content in files.items():
    with open(os.path.join(base_dir, filename), "w", encoding="utf-8") as f:
        f.write(content)

# Create ZIP file
zip_path = "/mnt/data/email-monitor-package.zip"
with zipfile.ZipFile(zip_path, "w", zipfile.ZIP_DEFLATED) as zipf:
    for filename in files:
        zipf.write(os.path.join(base_dir, filename), arcname=f"email/monitor/{filename}")

zip_path

----------

# æ‰“åŒ… Redis é˜Ÿåˆ—ç›‘æ§æ¨¡å—éƒ¨ç½²åŒ…
# Creating Redis queue monitoring deployment ZIP for email service
import os
import zipfile

# Define file structure and contents
base_dir = "/mnt/data/email/monitor"
os.makedirs(base_dir, exist_ok=True)

# File contents
redis_exporter = """const express = require('express');
const Redis = require('ioredis');
const app = express();
const redis = new Redis();

app.get('/metrics', async (req, res) => {
  const length = await redis.llen('queue:email');
  res.set('Content-Type', 'text/plain');
  res.send(`# HELP email_queue_length å½“å‰é‚®ä»¶é˜Ÿåˆ—é•¿åº¦\\n# TYPE email_queue_length gauge\\nemail_queue_length ${length}`);
});

app.listen(9100, () => {
  console.log('âœ… Prometheus exporter running on port 9100');
});
"""

prometheus_rules = """groups:
  - name: email-queue-alerts
    rules:
      - alert: EmailQueueTooLong
        expr: email_queue_length > 100
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "é‚®ä»¶é˜Ÿåˆ—é•¿åº¦è¶…è¿‡é˜ˆå€¼"
          description: "å½“å‰é˜Ÿåˆ—é•¿åº¦ä¸º {{ $value }}ï¼Œå¯èƒ½å­˜åœ¨æ¶ˆè´¹é˜»å¡"
"""

grafana_dashboard = """{
  "title": "Email Queue Dashboard",
  "panels": [
    {
      "type": "graph",
      "title": "é‚®ä»¶é˜Ÿåˆ—é•¿åº¦",
      "targets": [
        {
          "expr": "email_queue_length",
          "legendFormat": "é˜Ÿåˆ—é•¿åº¦"
        }
      ]
    }
  ]
}
"""

# Write files
with open(os.path.join(base_dir, "redisQueueExporter.js"), "w", encoding="utf-8") as f:
    f.write(redis_exporter)

with open(os.path.join(base_dir, "prometheus-alert-rules.yml"), "w", encoding="utf-8") as f:
    f.write(prometheus_rules)

with open(os.path.join(base_dir, "grafana-dashboard.json"), "w", encoding="utf-8") as f:
    f.write(grafana_dashboard)

# Create ZIP file
zip_path = "/mnt/data/email-monitor.zip"
with zipfile.ZipFile(zip_path, "w", zipfile.ZIP_DEFLATED) as zipf:
    for root, _, files in os.walk("/mnt/data/email"):
        for file in files:
            full_path = os.path.join(root, file)
            arcname = os.path.relpath(full_path, "/mnt/data")
            zipf.write(full_path, arcname)

zip_path

----------

# æ‰“åŒ… Redis é˜Ÿåˆ—ç›‘æ§æ¨¡å—éƒ¨ç½²åŒ…

----------
# Creating ZIP package for Redis queue monitoring module for email service
import os
import zipfile

# Define file structure and contents
base_dir = "/mnt/data/email/monitor"
os.makedirs(base_dir, exist_ok=True)

files = {
    "redisQueueExporter.js": """const express = require('express');
const Redis = require('ioredis');
const app = express();
const redis = new Redis();

app.get('/metrics', async (req, res) => {
  const length = await redis.llen('queue:email');
  res.set('Content-Type', 'text/plain');
  res.send(`# HELP email_queue_length å½“å‰é‚®ä»¶é˜Ÿåˆ—é•¿åº¦\\n# TYPE email_queue_length gauge\\nemail_queue_length ${length}`);
});

app.listen(9100, () => {
  console.log('âœ… Prometheus exporter running on port 9100');
});
""",
    "prometheus-alert-rules.yml": """groups:
  - name: email-queue-alerts
    rules:
      - alert: EmailQueueTooLong
        expr: email_queue_length > 100
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "é‚®ä»¶é˜Ÿåˆ—é•¿åº¦è¶…è¿‡é˜ˆå€¼"
          description: "å½“å‰é˜Ÿåˆ—é•¿åº¦ä¸º {{ $value }}ï¼Œå¯èƒ½å­˜åœ¨æ¶ˆè´¹é˜»å¡"
""",
    "grafana-dashboard.json": """{
  "title": "Email Queue Dashboard",
  "panels": [
    {
      "type": "graph",
      "title": "é‚®ä»¶é˜Ÿåˆ—é•¿åº¦",
      "targets": [
        {
          "expr": "email_queue_length",
          "legendFormat": "é˜Ÿåˆ—é•¿åº¦"
        }
      ]
    }
  ]
}
"""
}

# Write files to disk
for filename, content in files.items():
    with open(os.path.join(base_dir, filename), "w", encoding="utf-8") as f:
        f.write(content)

# Create ZIP file
zip_path = "/mnt/data/email-monitor-package.zip"
with zipfile.ZipFile(zip_path, "w", zipfile.ZIP_DEFLATED) as zipf:
    for filename in files:
        zipf.write(os.path.join(base_dir, filename), arcname=f"email/monitor/{filename}")

zip_path

# æ‰“åŒ… Redis é˜Ÿåˆ—ç›‘æ§æ¨¡å—éƒ¨ç½²åŒ…
# Creating ZIP deployment package for Redis queue monitoring module for email service
import os
import zipfile

# Define file structure and contents
base_dir = "/mnt/data/email/monitor"
os.makedirs(base_dir, exist_ok=True)

files = {
    "redisQueueExporter.js": """const express = require('express');
const Redis = require('ioredis');
const app = express();
const redis = new Redis();

app.get('/metrics', async (req, res) => {
  const length = await redis.llen('queue:email');
  res.set('Content-Type', 'text/plain');
  res.send(`# HELP email_queue_length å½“å‰é‚®ä»¶é˜Ÿåˆ—é•¿åº¦\\n# TYPE email_queue_length gauge\\nemail_queue_length ${length}`);
});

app.listen(9100, () => {
  console.log('âœ… Prometheus exporter running on port 9100');
});
""",
    "prometheus-alert-rules.yml": """groups:
  - name: email-queue-alerts
    rules:
      - alert: EmailQueueTooLong
        expr: email_queue_length > 100
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "é‚®ä»¶é˜Ÿåˆ—é•¿åº¦è¶…è¿‡é˜ˆå€¼"
          description: "å½“å‰é˜Ÿåˆ—é•¿åº¦ä¸º {{ $value }}ï¼Œå¯èƒ½å­˜åœ¨æ¶ˆè´¹é˜»å¡"
""",
    "grafana-dashboard.json": """{
  "title": "Email Queue Dashboard",
  "panels": [
    {
      "type": "graph",
      "title": "é‚®ä»¶é˜Ÿåˆ—é•¿åº¦",
      "targets": [
        {
          "expr": "email_queue_length",
          "legendFormat": "é˜Ÿåˆ—é•¿åº¦"
        }
      ]
    }
  ]
}
"""
}

# Write files
for filename, content in files.items():
    with open(os.path.join(base_dir, filename), "w", encoding="utf-8") as f:
        f.write(content)

# Create ZIP file
zip_path = "/mnt/data/email-monitor-package.zip"
with zipfile.ZipFile(zip_path, "w", zipfile.ZIP_DEFLATED) as zipf:
    for filename in files:
        zipf.write(os.path.join(base_dir, filename), arcname=f"email/monitor/{filename}")

zip_path

----------

# æ‰“åŒ… Redis é˜Ÿåˆ—ç›‘æ§æ¨¡å—éƒ¨ç½²åŒ…
# Creating Redis queue monitoring deployment ZIP for email service
import os
import zipfile

# Define file structure and contents
base_dir = "/mnt/data/email/monitor"
os.makedirs(base_dir, exist_ok=True)

# File contents
redis_exporter = """const express = require('express');
const Redis = require('ioredis');
const app = express();
const redis = new Redis();

app.get('/metrics', async (req, res) => {
  const length = await redis.llen('queue:email');
  res.set('Content-Type', 'text/plain');
  res.send(`# HELP email_queue_length å½“å‰é‚®ä»¶é˜Ÿåˆ—é•¿åº¦\\n# TYPE email_queue_length gauge\\nemail_queue_length ${length}`);
});

app.listen(9100, () => {
  console.log('âœ… Prometheus exporter running on port 9100');
});
"""

prometheus_rules = """groups:
  - name: email-queue-alerts
    rules:
      - alert: EmailQueueTooLong
        expr: email_queue_length > 100
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "é‚®ä»¶é˜Ÿåˆ—é•¿åº¦è¶…è¿‡é˜ˆå€¼"
          description: "å½“å‰é˜Ÿåˆ—é•¿åº¦ä¸º {{ $value }}ï¼Œå¯èƒ½å­˜åœ¨æ¶ˆè´¹é˜»å¡"
"""

grafana_dashboard = """{
  "title": "Email Queue Dashboard",
  "panels": [
    {
      "type": "graph",
      "title": "é‚®ä»¶é˜Ÿåˆ—é•¿åº¦",
      "targets": [
        {
          "expr": "email_queue_length",
          "legendFormat": "é˜Ÿåˆ—é•¿åº¦"
        }
      ]
    }
  ]
}
"""

# Write files
with open(os.path.join(base_dir, "redisQueueExporter.js"), "w", encoding="utf-8") as f:
    f.write(redis_exporter)

with open(os.path.join(base_dir, "prometheus-alert-rules.yml"), "w", encoding="utf-8") as f:
    f.write(prometheus_rules)

with open(os.path.join(base_dir, "grafana-dashboard.json"), "w", encoding="utf-8") as f:
    f.write(grafana_dashboard)

# Create ZIP file
zip_path = "/mnt/data/email-monitor-package.zip"
with zipfile.ZipFile(zip_path, "w", zipfile.ZIP_DEFLATED) as zipf:
    for root, _, files in os.walk("/mnt/data/email"):
        for file in files:
            full_path = os.path.join(root, file)
            rel_path = os.path.relpath(full_path, "/mnt/data")
            zipf.write(full_path, rel_path)

zip_path

----------

# æ‰“åŒ… Redis é˜Ÿåˆ—ç›‘æ§æ¨¡å—éƒ¨ç½²åŒ…
# Creating ZIP deployment package for Redis queue monitoring module for email service
import os
import zipfile

# Define file structure and contents
base_dir = "/mnt/data/email/monitor"
os.makedirs(base_dir, exist_ok=True)

# File contents
redis_exporter_code = """const express = require('express');
const Redis = require('ioredis');
const app = express();
const redis = new Redis();

app.get('/metrics', async (req, res) => {
  const length = await redis.llen('queue:email');
  res.set('Content-Type', 'text/plain');
  res.send(`# HELP email_queue_length å½“å‰é‚®ä»¶é˜Ÿåˆ—é•¿åº¦\\n# TYPE email_queue_length gauge\\nemail_queue_length ${length}`);
});

app.listen(9100, () => {
  console.log('âœ… Prometheus exporter running on port 9100');
});
"""

prometheus_alert_rules = """groups:
  - name: email-queue-alerts
    rules:
      - alert: EmailQueueTooLong
        expr: email_queue_length > 100
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "é‚®ä»¶é˜Ÿåˆ—é•¿åº¦è¶…è¿‡é˜ˆå€¼"
          description: "å½“å‰é˜Ÿåˆ—é•¿åº¦ä¸º {{ $value }}ï¼Œå¯èƒ½å­˜åœ¨æ¶ˆè´¹é˜»å¡"
"""

grafana_dashboard_json = """{
  "title": "Email Queue Dashboard",
  "panels": [
    {
      "type": "graph",
      "title": "é‚®ä»¶é˜Ÿåˆ—é•¿åº¦",
      "targets": [
        {
          "expr": "email_queue_length",
          "legendFormat": "é˜Ÿåˆ—é•¿åº¦"
        }
      ]
    }
  ]
}
"""

# Write files
with open(os.path.join(base_dir, "redisQueueExporter.js"), "w", encoding="utf-8") as f:
    f.write(redis_exporter_code)

with open(os.path.join(base_dir, "prometheus-alert-rules.yml"), "w", encoding="utf-8") as f:
    f.write(prometheus_alert_rules)

with open(os.path.join(base_dir, "grafana-dashboard.json"), "w", encoding="utf-8") as f:
    f.write(grafana_dashboard_json)

# Create ZIP file
zip_path = "/mnt/data/email-monitor-package.zip"
with zipfile.ZipFile(zip_path, "w", zipfile.ZIP_DEFLATED) as zipf:
    for root, _, files in os.walk("/mnt/data/email"):
        for file in files:
            full_path = os.path.join(root, file)
            arcname = os.path.relpath(full_path, "/mnt/data")
            zipf.write(full_path, arcname)

zip_path

----------
# æ‰“åŒ… Redis é˜Ÿåˆ—ç›‘æ§æ¨¡å—éƒ¨ç½²åŒ…
# Creating Redis queue monitoring deployment ZIP for email service
import os
import zipfile

# Define file structure and contents
base_dir = "/mnt/data/email/monitor"
os.makedirs(base_dir, exist_ok=True)

# File contents
redis_exporter_code = """const express = require('express');
const Redis = require('ioredis');
const app = express();
const redis = new Redis();

app.get('/metrics', async (req, res) => {
  const length = await redis.llen('queue:email');
  res.set('Content-Type', 'text/plain');
  res.send(`# HELP email_queue_length å½“å‰é‚®ä»¶é˜Ÿåˆ—é•¿åº¦\\n# TYPE email_queue_length gauge\\nemail_queue_length ${length}`);
});

app.listen(9100, () => {
  console.log('âœ… Prometheus exporter running on port 9100');
});
"""

prometheus_alert_rules = """groups:
  - name: email-queue-alerts
    rules:
      - alert: EmailQueueTooLong
        expr: email_queue_length > 100
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "é‚®ä»¶é˜Ÿåˆ—é•¿åº¦è¶…è¿‡é˜ˆå€¼"
          description: "å½“å‰é˜Ÿåˆ—é•¿åº¦ä¸º {{ $value }}ï¼Œå¯èƒ½å­˜åœ¨æ¶ˆè´¹é˜»å¡"
"""

grafana_dashboard_json = """{
  "title": "Email Queue Dashboard",
  "panels": [
    {
      "type": "graph",
      "title": "é‚®ä»¶é˜Ÿåˆ—é•¿åº¦",
      "targets": [
        {
          "expr": "email_queue_length",
          "legendFormat": "é˜Ÿåˆ—é•¿åº¦"
        }
      ]
    }
  ]
}
"""

# Write files
with open(os.path.join(base_dir, "redisQueueExporter.js"), "w", encoding="utf-8") as f:
    f.write(redis_exporter_code)

with open(os.path.join(base_dir, "prometheus-alert-rules.yml"), "w", encoding="utf-8") as f:
    f.write(prometheus_alert_rules)

with open(os.path.join(base_dir, "grafana-dashboard.json"), "w", encoding="utf-8") as f:
    f.write(grafana_dashboard_json)

# Create ZIP file
zip_path = "/mnt/data/email-monitor-deployment.zip"
with zipfile.ZipFile(zip_path, "w", zipfile.ZIP_DEFLATED) as zipf:
    for root, _, files in os.walk("/mnt/data/email"):
        for file in files:
            full_path = os.path.join(root, file)
            arcname = os.path.relpath(full_path, "/mnt/data")
            zipf.write(full_path, arcname)

zip_path

----------

âœ…ã€‚ä»¥ä¸‹æ˜¯ä¸Šè¿°æ‰“åŒ…æ¨¡å— Redis é˜Ÿåˆ—ç›‘æ§æ¨¡å—çš„ä½¿ç”¨æŒ‡å—ï¼Œæ¶µç›–éƒ¨ç½²ã€å¯åŠ¨ã€Prometheus é…ç½®ã€Grafanaå¯¼å…¥ä¸å‘Šè­¦è”åŠ¨ï¼Œç¡®ä¿ä½ èƒ½å¿«é€Ÿä¸Šçº¿å¹¶å®ç°é˜Ÿåˆ—å¯è§‚æµ‹æ€§ã€‚

email/
â””â”€â”€ monitor/
    â”œâ”€â”€ redisQueueExporter.js           # Prometheus exporter
    â”œâ”€â”€ prometheus-alert-rules.yml     # å‘Šè­¦è§„åˆ™
    â””â”€â”€ grafana-dashboard.json         # Grafana é¢æ¿

---

## ğŸš€ ä½¿ç”¨æ­¥éª¤è¯¦è§£

### âœ… 1. å¯åŠ¨ Redis Exporter

```bash
cd /mnt/data/www/email/monitor
node redisQueueExporter.js
```

- é»˜è®¤ç›‘å¬ç«¯å£ï¼š`9100`
- å¯ä½¿ç”¨ `pm2` æˆ– `systemd` å®ˆæŠ¤è¿è¡Œï¼ˆæ¨èï¼‰

---

### âœ… 2. é…ç½® Prometheus æ‹‰å–æŒ‡æ ‡

ğŸ“„ ç¼–è¾‘ `prometheus.yml`ï¼š

```yaml
scrape_configs:
  - job_name: 'email-queue'
    static_configs:
      - targets: ['localhost:9100']
```

> âœ… é‡å¯ Prometheus åå¯è®¿é—® `http://localhost:9090/graph` æŸ¥è¯¢ `email_queue_length`

---

### âœ… 3. å¯¼å…¥ Grafana é¢æ¿

ğŸ“„ æ“ä½œæ­¥éª¤ï¼š

1. æ‰“å¼€ Grafana â†’ Dashboards â†’ Import
2. ä¸Šä¼  `grafana-dashboard.json`
3. é€‰æ‹©æ•°æ®æºï¼ˆPrometheusï¼‰
4. æŸ¥çœ‹é˜Ÿåˆ—é•¿åº¦å›¾è¡¨

---

### âœ… 4. é…ç½® Prometheus å‘Šè­¦è§„åˆ™

ğŸ“„ å°† `prometheus-alert-rules.yml` æ·»åŠ åˆ° Prometheus çš„ `rule_files`ï¼š

```yaml
rule_files:
  - "email/monitor/prometheus-alert-rules.yml"
```

ğŸ“„ å‘Šè­¦è§„åˆ™å†…å®¹ï¼š

```yaml
- alert: EmailQueueTooLong
  expr: email_queue_length > 100
  for: 1m
  labels:
    severity: warning
  annotations:
    summary: "é‚®ä»¶é˜Ÿåˆ—é•¿åº¦è¶…è¿‡é˜ˆå€¼"
    description: "å½“å‰é˜Ÿåˆ—é•¿åº¦ä¸º {{ $value }}ï¼Œå¯èƒ½å­˜åœ¨æ¶ˆè´¹é˜»å¡"
```

> âœ… å¯è”åŠ¨ Alertmanager å‘é€é’‰é’‰ã€é£ä¹¦ã€é‚®ä»¶é€šçŸ¥

---

## ğŸ§  å®è·µå»ºè®®

- ä½¿ç”¨ `pm2 start redisQueueExporter.js --name email-exporter` å®ˆæŠ¤è¿è¡Œ
- å°† exporter ç«¯å£æš´éœ²è‡³å†…ç½‘ Prometheus èŠ‚ç‚¹
- åœ¨ Grafana ä¸­æ·»åŠ é˜Ÿåˆ—æ¶ˆè´¹é€Ÿç‡ã€å¤±è´¥ç‡ç­‰æŒ‡æ ‡
- å¯æ‰©å±• exporter æ”¯æŒæ›´å¤šæŒ‡æ ‡ï¼Œå¦‚ `email_sent_total`ã€`email_failed_total`

---
âœ… ä»¥ä¸‹æ˜¯ Redis é˜Ÿåˆ—ç›‘æ§æ¨¡å—çš„å®Œæ•´è”åŠ¨æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š

1. `pm2` å¯åŠ¨é…ç½®æ–‡ä»¶  
2. `Alertmanager` é€šçŸ¥æ¨¡æ¿  
3. CI/CD å·¥ä½œæµé›†æˆç›‘æ§æ¨¡å—éƒ¨ç½²ä¸éªŒè¯

---

## ğŸ§© 1. `pm2` å¯åŠ¨é…ç½®æ–‡ä»¶ï¼ˆè·¯å¾„ï¼š`email/monitor/ecosystem.config.js`ï¼‰

```js
module.exports = {
  apps: [
    {
      name: 'email-exporter',
      script: 'redisQueueExporter.js',
      cwd: './monitor',
      instances: 1,
      autorestart: true,
      watch: false,
      env: {
        NODE_ENV: 'production',
        REDIS_HOST: '127.0.0.1',
        REDIS_PORT: 6379
      },
      output: './logs/exporter.log',
      error: './logs/exporter-error.log'
    }
  ]
};
```

> âœ… å¯åŠ¨æ–¹å¼ï¼š

```bash
pm2 start monitor/ecosystem.config.js
pm2 save
pm2 startup
```

---

## ğŸ“£ 2. Alertmanager é€šçŸ¥æ¨¡æ¿ï¼ˆè·¯å¾„ï¼š`email/monitor/alertmanager-template.yml`ï¼‰

```yaml
templates:
  - '/etc/alertmanager/email-template.tmpl'

receivers:
  - name: 'email-team'
    email_configs:
      - to: 'ops@0379.email'
        from: 'alert@0379.email'
        smarthost: 'smtp.0379.email:465'
        auth_username: 'alert@0379.email'
        auth_password: 'your_smtp_password'
        require_tls: true
        send_resolved: true
        html: '{{ template "email.default.html" . }}'

route:
  receiver: 'email-team'
```

ğŸ“„ ç¤ºä¾‹æ¨¡æ¿æ–‡ä»¶ï¼ˆ`email-template.tmpl`ï¼‰ï¼š

```tmpl
{{ define "email.default.html" }}
<h3>ğŸš¨ å‘Šè­¦ï¼š{{ .CommonLabels.alertname }}</h3>
<p>{{ .CommonAnnotations.description }}</p>
<p>çŠ¶æ€ï¼š{{ .Status }}</p>
<p>å€¼ï¼š{{ .CommonLabels.instance }} - {{ .CommonLabels.job }}</p>
{{ end }}
```

---

## ğŸ” 3. CI/CD é›†æˆç›‘æ§æ¨¡å—ï¼ˆè·¯å¾„ï¼š`.github/workflows/deploy-monitor.yml`ï¼‰

```yaml
name: Deploy Redis Monitor

on:
  push:
    paths:
      - 'monitor/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Sync monitor module to server
        run: |
          scp -r monitor user@aliyun-host:/mnt/data/www/email/
          ssh user@aliyun-host "pm2 restart email-exporter || pm2 start /mnt/data/www/email/monitor/ecosystem.config.js"
```

> âœ… æ¯æ¬¡æ›´æ–°ç›‘æ§æ¨¡å—è‡ªåŠ¨éƒ¨ç½²å¹¶é‡å¯ exporter

---

# æ‰“åŒ… Redis é˜Ÿåˆ—ç›‘æ§è”åŠ¨æ¨¡å—
# Creating Redis queue monitoring integration ZIP for email service

import os
import zipfile

# Define file structure and contents
base_dir = "/mnt/data/email/monitor"
os.makedirs(base_dir, exist_ok=True)

files = {
    "grafana-import.sh": """#!/bin/bash
GRAFANA_URL=http://localhost:3000
API_KEY="your_grafana_api_key"
DASHBOARD_PATH="grafana-dashboard.json"

curl -X POST $GRAFANA_URL/api/dashboards/db \\
  -H "Authorization: Bearer $API_KEY" \\
  -H "Content-Type: application/json" \\
  -d @${DASHBOARD_PATH}
""",
    "prometheus-dynamic-scrape.js": """const fs = require('fs');
const targets = ['localhost:9100', '192.168.3.45:9100'];
const config = {
  scrape_configs: targets.map((t, i) => ({
    job_name: `email-queue-${i}`,
    static_configs: [{ targets: [t] }]
  }))
};
fs.writeFileSync('prometheus-dynamic.yml', JSON.stringify(config, null, 2));
""",
    "alertmanager-feishu.yml": """receivers:
  - name: 'feishu'
    webhook_configs:
      - url: 'https://open.feishu.cn/open-apis/bot/v2/hook/your_webhook_token'
""",
    "alertmanager-dingtalk.yml": """receivers:
  - name: 'dingtalk'
    webhook_configs:
      - url: 'https://oapi.dingtalk.com/robot/send?access_token=your_token'
""",
    "alertmanager-slack.yml": """receivers:
  - name: 'slack'
    slack_configs:
      - channel: '#alerts'
        api_url: 'https://hooks.slack.com/services/your/slack/webhook'
"""
}

# Write files
for filename, content in files.items():
    with open(os.path.join(base_dir, filename), "w") as f:
        f.write(content)

# Create ZIP file
zip_path = "/mnt/data/email-monitor.zip"
with zipfile.ZipFile(zip_path, "w") as zipf:
    for filename in files.keys():
        zipf.write(os.path.join(base_dir, filename), arcname=f"email/monitor/{filename}")

print("ZIP file created:", zip_path)
# å®Œæ•´ ZIP åŒ…ï¼Œéƒ¨ç½²è‡³ç›‘æ§æ¨¡å—ç›®å½•ã€‚æ‰€æœ‰è„šæœ¬ä¸é…ç½®å‡ä¸ºå¯è¿è¡ŒçŠ¶æ€ï¼Œæ”¯æŒç›´æ¥é›†æˆåˆ°ä½ çš„å‘å¸ƒæµç¨‹ä¸å‘Šè­¦ä½“ç³»ä¸­ã€‚

**âœ… å·²ç”Ÿæˆ Grafana é¢æ¿å¯¼å…¥è„šæœ¬ã€Prometheus scrape job è‡ªåŠ¨æ³¨å†Œå™¨ï¼Œä»¥åŠ Alertmanager å‘Šè­¦è”åŠ¨é…ç½®ï¼ˆé£ä¹¦ã€é’‰é’‰ã€Slackï¼‰ï¼Œå…¨éƒ¨å¯éƒ¨ç½²è‡³ email/monitor æ¨¡å—ä¸­ã€‚**

---

## ğŸ“ æ¨¡å—ç»“æ„ï¼ˆéƒ¨ç½²è·¯å¾„å»ºè®®ï¼š`/mnt/data/www/email/monitor/`ï¼‰

```
monitor/
â”œâ”€â”€ grafana-import.sh                  # Grafana é¢æ¿å¯¼å…¥è„šæœ¬
â”œâ”€â”€ prometheus-dynamic-scrape.js      # Prometheus scrape job è‡ªåŠ¨ç”Ÿæˆå™¨
â”œâ”€â”€ alertmanager-feishu.yml           # é£ä¹¦å‘Šè­¦é…ç½®
â”œâ”€â”€ alertmanager-dingtalk.yml         # é’‰é’‰å‘Šè­¦é…ç½®
â”œâ”€â”€ alertmanager-slack.yml            # Slack å‘Šè­¦é…ç½®
```

---

## ğŸ§© ä½¿ç”¨è¯´æ˜

### âœ… 1. å¯¼å…¥ Grafana é¢æ¿

```bash
bash monitor/grafana-import.sh
```

- éœ€è®¾ç½®ç¯å¢ƒå˜é‡ `GRAFANA_URL` ä¸ `API_KEY`
- é»˜è®¤å¯¼å…¥ `grafana-dashboard.json` åˆ°æœ¬åœ° Grafana å®ä¾‹

---

### âœ… 2. è‡ªåŠ¨ç”Ÿæˆ Prometheus scrape job

```bash
node monitor/prometheus-dynamic-scrape.js
```

- è¾“å‡ºæ–‡ä»¶ï¼š`prometheus-dynamic.yml`
- å†…å®¹ç¤ºä¾‹ï¼š

```yaml
scrape_configs:
  - job_name: email-queue-0
    static_configs:
      - targets: ['localhost:9100']
  - job_name: email-queue-1
    static_configs:
      - targets: ['192.168.3.45:9100']
```

> âœ… å¯é›†æˆåˆ° CI/CD æˆ–éƒ¨ç½²è„šæœ¬ä¸­è‡ªåŠ¨æ›´æ–° Prometheus é…ç½®

---

### âœ… 3. å‘Šè­¦è”åŠ¨é…ç½®ï¼ˆAlertmanagerï¼‰

#### ğŸ“„ é£ä¹¦ï¼ˆalertmanager-feishu.ymlï¼‰

```yaml
receivers:
  - name: 'feishu'
    webhook_configs:
      - url: 'https://open.feishu.cn/open-apis/bot/v2/hook/your_webhook_token'
```

#### ğŸ“„ é’‰é’‰ï¼ˆalertmanager-dingtalk.ymlï¼‰

```yaml
receivers:
  - name: 'dingtalk'
    webhook_configs:
      - url: 'https://oapi.dingtalk.com/robot/send?access_token=your_token'
```

#### ğŸ“„ Slackï¼ˆalertmanager-slack.ymlï¼‰

```yaml
receivers:
  - name: 'slack'
    slack_configs:
      - channel: '#alerts'
        api_url: 'https://hooks.slack.com/services/your/slack/webhook'
```

> âœ… å¯åœ¨ `alertmanager.yml` ä¸­å¼•ç”¨è¿™äº›é…ç½®æ–‡ä»¶ï¼Œå®ç°å¤šæ¸ é“å‘Šè­¦è”åŠ¨

---

âœ… ä»¥ä¸‹æ˜¯å¹³å°çš„å‘Šè­¦éªŒè¯ä¸å‘å¸ƒè”åŠ¨æ–¹æ¡ˆï¼Œé›†æˆåˆ° CI/CD å·¥ä½œæµä¸­ï¼Œç¡®ä¿æ¯æ¬¡éƒ¨ç½²éƒ½è‡ªåŠ¨éªŒè¯ç›‘æ§çŠ¶æ€ï¼Œå¹¶å°†å‘Šè­¦æ‘˜è¦åŒæ­¥åˆ° changelog é¡µé¢ã€‚

---

## ğŸ§© 1. CI/CD å·¥ä½œæµè‡ªåŠ¨è§¦å‘å‘Šè­¦éªŒè¯ä»»åŠ¡

ğŸ“„ æ–‡ä»¶è·¯å¾„å»ºè®®ï¼š`.github/workflows/verify-alerts.yml`

```yaml
name: Verify Prometheus Alerts

on:
  workflow_dispatch:
  push:
    paths:
      - 'monitor/**'
      - 'docs/changelog.json'

jobs:
  verify-alerts:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Prometheus Alerts
        run: |
          curl -s http://prometheus.0379.email/api/v1/alerts > alerts.json
          cat alerts.json

      - name: Extract Active Alerts
        run: |
          jq '.data.alerts[] | select(.state=="firing") | {name: .labels.alertname, desc: .annotations.description}' alerts.json > active-alerts.json

      - name: Sync to changelog
        run: |
          echo "ğŸ“¦ æ›´æ–° changelog.json ä¸­çš„å‘Šè­¦æ‘˜è¦"
          node monitor/syncAlertsToChangelog.js
```

---

## ğŸ“„ 2. å‘Šè­¦çŠ¶æ€åŒæ­¥è„šæœ¬ï¼ˆè·¯å¾„ï¼š`monitor/syncAlertsToChangelog.js`ï¼‰

```js
const fs = require('fs');
const alerts = JSON.parse(fs.readFileSync('active-alerts.json'));
const changelog = JSON.parse(fs.readFileSync('docs/changelog.json'));

const latestVersion = Object.keys(changelog).sort().reverse()[0];
const entry = changelog[latestVersion];

entry.alerts = alerts.map(a => `ğŸš¨ ${a.name}: ${a.desc}`);
fs.writeFileSync('docs/changelog.json', JSON.stringify(changelog, null, 2));

console.log(`âœ… å·²åŒæ­¥ ${alerts.length} æ¡å‘Šè­¦åˆ° changelog.json`);
```

> âœ… æ¯æ¬¡éƒ¨ç½²åè‡ªåŠ¨å°†å½“å‰å‘Šè­¦æ‘˜è¦å†™å…¥ changelog é¡µé¢

---

## ğŸ“„ 3. changelog é¡µé¢å¢å¼ºå±•ç¤ºï¼ˆè·¯å¾„ï¼š`docs/changelog.html`ï¼‰

æ·»åŠ å‘Šè­¦åŒºå—ï¼š

```html
<h3>ğŸš¨ å½“å‰å‘Šè­¦æ‘˜è¦</h3>
<ul>
  <li>ğŸš¨ EmailQueueTooLong: é‚®ä»¶é˜Ÿåˆ—é•¿åº¦è¶…è¿‡é˜ˆå€¼</li>
  <li>ğŸš¨ RedisDisconnected: Redis è¿æ¥å¼‚å¸¸</li>
</ul>
```

> âœ… å¯è‡ªåŠ¨æ¸²æŸ“ `entry.alerts` å†…å®¹ï¼Œæ”¯æŒä¸­è‹±æ–‡åˆ‡æ¢

---

## âœ… å‘å¸ƒè”åŠ¨é—­ç¯

```mermaid
graph TD
  A[CI/CD å‘å¸ƒè§¦å‘] --> B[éªŒè¯ Prometheus å‘Šè­¦]
  B --> C[æå– firing çŠ¶æ€]
  C --> D[å†™å…¥ changelog.json]
  D --> E[æ›´æ–° changelog é¡µé¢]
```

---

# ä»¥ä¸‹æ˜¯ changelog é¡µé¢è‡ªåŠ¨æ¸²æŸ“å‘Šè­¦åŒºå—çš„ JS æ¨¡æ¿ï¼Œä»¥åŠå°†å‘Šè­¦æ‘˜è¦æ¨é€åˆ°é£ä¹¦/é’‰é’‰ç¾¤çš„ webhook è„šæœ¬ï¼Œå¸®åŠ©ä½ å®ç° changelog é¡µé¢è”åŠ¨ä¸å›¢é˜Ÿé€šçŸ¥æ•´åˆã€‚

---

## ğŸ§© 1. changelog é¡µé¢è‡ªåŠ¨æ¸²æŸ“å‘Šè­¦åŒºå—ï¼ˆè·¯å¾„ï¼š`docs/changelog.html`ï¼‰

### âœ… HTML æ’æ§½ï¼š

```html
<h3>ğŸš¨ å½“å‰å‘Šè­¦æ‘˜è¦</h3>
<ul id="alertList"></ul>
```

### âœ… JS æ¨¡æ¿ï¼ˆæ’å…¥ `<script>` ä¸­ï¼‰ï¼š

```js
fetch('changelog.json')
  .then(res => res.json())
  .then(data => {
    const latest = Object.keys(data).sort().reverse()[0];
    const alerts = data[latest].alerts || [];
    const ul = document.getElementById('alertList');
    alerts.forEach(msg => {
      const li = document.createElement('li');
      li.textContent = msg;
      ul.appendChild(li);
    });
  });
```

> âœ… è‡ªåŠ¨è¯»å–æœ€æ–°ç‰ˆæœ¬çš„ `alerts` å­—æ®µå¹¶æ¸²æŸ“ä¸ºåˆ—è¡¨

---

## ğŸ“¤ 2. å‘Šè­¦æ‘˜è¦æ¨é€è„šæœ¬ï¼ˆè·¯å¾„ï¼š`monitor/pushAlertsToIM.js`ï¼‰

```js
const fs = require('fs');
const https = require('https');

const alerts = JSON.parse(fs.readFileSync('active-alerts.json'));
const summary = alerts.map(a => `ğŸš¨ ${a.name}: ${a.desc}`).join('\n');

function postToFeishu() {
  const data = JSON.stringify({ msg_type: 'text', content: { text: summary } });
  const req = https.request({
    hostname: 'open.feishu.cn',
    path: '/open-apis/bot/v2/hook/your_webhook_token',
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Content-Length': data.length }
  }, res => console.log(`Feishu: ${res.statusCode}`));
  req.write(data); req.end();
}

function postToDingTalk() {
  const data = JSON.stringify({ msgtype: 'text', text: { content: summary } });
  const req = https.request({
    hostname: 'oapi.dingtalk.com',
    path: '/robot/send?access_token=your_token',
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Content-Length': data.length }
  }, res => console.log(`DingTalk: ${res.statusCode}`));
  req.write(data); req.end();
}

postToFeishu();
postToDingTalk();
```

> âœ… å¯åœ¨ CI/CD ä¸­è°ƒç”¨ `node monitor/pushAlertsToIM.js` å®ç°è‡ªåŠ¨æ¨é€

---

## âœ… è”åŠ¨æµç¨‹å›¾

```mermaid
graph TD
  A[Prometheus å‘Šè­¦éªŒè¯] --> B[active-alerts.json]
  B --> C[å†™å…¥ changelog.json]
  C --> D[æ¸²æŸ“ changelog é¡µé¢]
  B --> E[æ¨é€é£ä¹¦/é’‰é’‰]
```

---

âœ… ä»¥ä¸‹æ˜¯ changelog é¡µé¢å›½é™…åŒ–æ”¯æŒï¼ˆä¸­è‹±æ–‡åˆ‡æ¢ï¼‰ä¸å‘Šè­¦æ‘˜è¦åŒæ­¥åˆ°å‘å¸ƒæŠ¥å‘Šçš„å®Œæ•´æ–¹æ¡ˆï¼Œå¸®åŠ©ä½ æ„å»ºä¸€ä¸ªå¤šè¯­è¨€ã€è”åŠ¨å¼çš„å‘å¸ƒæ–‡æ¡£ä½“ç³»ã€‚

---

## ğŸŒ 1. changelog é¡µé¢å›½é™…åŒ–æ”¯æŒï¼ˆä¸­è‹±æ–‡åˆ‡æ¢ï¼‰

### âœ… æ–‡ä»¶ç»“æ„å»ºè®®

```
docs/
â”œâ”€â”€ changelog.json
â”œâ”€â”€ changelog.html
â”œâ”€â”€ i18n/
â”‚   â”œâ”€â”€ zh.json
â”‚   â””â”€â”€ en.json
```

### âœ… `i18n/zh.json`

```json
{
  "title": "ç‰ˆæœ¬å˜æ›´è®°å½•",
  "alerts": "å½“å‰å‘Šè­¦æ‘˜è¦",
  "noAlerts": "æš‚æ— å‘Šè­¦",
  "version": "ç‰ˆæœ¬",
  "date": "å‘å¸ƒæ—¥æœŸ",
  "changes": "å˜æ›´å†…å®¹"
}
```

### âœ… `i18n/en.json`

```json
{
  "title": "Changelog",
  "alerts": "Active Alerts",
  "noAlerts": "No alerts",
  "version": "Version",
  "date": "Release Date",
  "changes": "Changes"
}
```

### âœ… JS å›½é™…åŒ–åˆ‡æ¢æ¨¡æ¿ï¼ˆåµŒå…¥ `changelog.html`ï¼‰

```html
<select id="langSwitcher">
  <option value="zh">ä¸­æ–‡</option>
  <option value="en">English</option>
</select>

<script>
let lang = localStorage.getItem('lang') || 'zh';
document.getElementById('langSwitcher').value = lang;

function loadLang(lang) {
  fetch(`i18n/${lang}.json`)
    .then(res => res.json())
    .then(dict => {
      document.querySelector('h1').textContent = dict.title;
      document.querySelector('#alertTitle').textContent = dict.alerts;
      // å…¶ä»–å­—æ®µæ›¿æ¢é€»è¾‘...
    });
}

document.getElementById('langSwitcher').onchange = e => {
  lang = e.target.value;
  localStorage.setItem('lang', lang);
  loadLang(lang);
};

loadLang(lang);
</script>
```

> âœ… é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åˆ‡æ¢è¯­è¨€ï¼Œæ”¯æŒç”¨æˆ·é€‰æ‹©å¹¶è®°å¿†åå¥½

---

## ğŸ“„ 2. å‘Šè­¦æ‘˜è¦åŒæ­¥åˆ°å‘å¸ƒæŠ¥å‘Šï¼ˆè·¯å¾„ï¼š`scripts/gen-release-report.js`ï¼‰

```js
const fs = require('fs');
const changelog = JSON.parse(fs.readFileSync('docs/changelog.json'));
const latest = Object.keys(changelog).sort().reverse()[0];
const entry = changelog[latest];

const lines = [
  `# ğŸ“¦ å‘å¸ƒæŠ¥å‘Š ${latest}`,
  `- å‘å¸ƒæ—¶é—´ï¼š${entry.date}`,
  `- å‘å¸ƒç‰ˆæœ¬ï¼š${latest}`,
  `- å‘å¸ƒå†…å®¹ï¼š`,
  ...entry.changes.map(c => `  - ${c}`),
  '',
  `## ğŸš¨ å½“å‰å‘Šè­¦æ‘˜è¦`,
  ...(entry.alerts?.length ? entry.alerts.map(a => `- ${a}`) : ['- æ— å‘Šè­¦']),
  '',
  `## ğŸ”— é“¾æ¥`,
  `- [Changelog é¡µé¢](changelog.html)`
];

fs.writeFileSync(`docs/release-report-${latest}.md`, lines.join('\n'));
console.log(`âœ… å‘å¸ƒæŠ¥å‘Šå·²ç”Ÿæˆï¼šrelease-report-${latest}.md`);
```

> âœ… æ¯æ¬¡å‘å¸ƒè‡ªåŠ¨ç”ŸæˆæŠ¥å‘Šå¹¶åµŒå…¥å‘Šè­¦æ‘˜è¦ï¼Œæ”¯æŒä¸­è‹±æ–‡ç‰ˆæœ¬æ‰©å±•

---

## ğŸ§  å‘å¸ƒæ–‡æ¡£è”åŠ¨å»ºè®®

- å°† `release-report-*.md` æäº¤è‡³ Git ä»“åº“
- åœ¨ GitHub/GitLab Release é¡µé¢é™„åŠ æŠ¥å‘Š
- åœ¨ changelog é¡µé¢æ·»åŠ â€œæŸ¥çœ‹å‘å¸ƒæŠ¥å‘Šâ€æŒ‰é’®
- æ”¯æŒ `?lang=zh` æˆ– `?lang=en` URL å‚æ•°åˆ‡æ¢è¯­è¨€

---
# ä¸‹ä¸€é˜¶æ®µ
# ç”Ÿæˆ changelog é¡µé¢æœç´¢åŠŸèƒ½ã€ç‰ˆæœ¬å¯¹æ¯”è§†å›¾è”åŠ¨ã€å°† changelog é¡µé¢åµŒå…¥å›¢é˜Ÿ Wiki é¦–é¡µã€‚ç»§ç»­æ¨è¿› changelog é¡µé¢åŠŸèƒ½å¢å¼ºä¸å›¢é˜Ÿåä½œæ•´åˆ