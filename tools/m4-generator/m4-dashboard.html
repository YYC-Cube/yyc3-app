<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M4æ™ºèƒ½è„šæœ¬ç”Ÿæˆå™¨ - YYCÂ³ AI Family</title>
    <link rel="stylesheet" href="/styles.css">
    <style>
        .m4-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .m4-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .m4-title {
            font-size: 2.5rem;
            color: #3B82F6;
            margin-bottom: 1rem;
        }

        .m4-subtitle {
            color: #64748B;
            font-size: 1.1rem;
        }

        .m4-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .m4-section {
            background: #F8FAFC;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #E2E8F0;
        }

        .m4-section h3 {
            color: #1E293B;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            color: #374151;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 200px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.875rem;
        }

        .btn {
            background: #3B82F6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #2563EB;
        }

        .btn:disabled {
            background: #9CA3AF;
            cursor: not-allowed;
        }

        .btn-success {
            background: #10B981;
        }

        .btn-success:hover {
            background: #059669;
        }

        .m4-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #E2E8F0;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #3B82F6;
        }

        .stat-label {
            color: #64748B;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .template-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .template-card {
            background: white;
            padding: 1.25rem;
            border-radius: 8px;
            border: 2px solid #E2E8F0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-card:hover {
            border-color: #3B82F6;
            transform: translateY(-2px);
        }

        .template-card.selected {
            border-color: #3B82F6;
            background: #EFF6FF;
        }

        .template-name {
            font-weight: 600;
            color: #1E293B;
            margin-bottom: 0.5rem;
        }

        .template-description {
            color: #64748B;
            font-size: 0.875rem;
        }

        .template-category {
            display: inline-block;
            background: #E2E8F0;
            color: #374151;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-top: 0.5rem;
        }

        .result-section {
            background: #F8FAFC;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
            border: 1px solid #E2E8F0;
        }

        .result-section h3 {
            color: #1E293B;
            margin-bottom: 1rem;
        }

        .generated-script {
            background: #1E293B;
            color: #F1F5F9;
            padding: 1.5rem;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.875rem;
            line-height: 1.5;
            overflow-x: auto;
            white-space: pre;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #64748B;
        }

        .error {
            background: #FEF2F2;
            color: #DC2626;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #FECACA;
            margin-bottom: 1rem;
        }

        .success {
            background: #F0FDF4;
            color: #059669;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #BBF7D0;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="m4-container">
        <div class="m4-header">
            <h1 class="m4-title">ğŸ”§ M4æ™ºèƒ½è„šæœ¬ç”Ÿæˆå™¨</h1>
            <p class="m4-subtitle">YYCÂ³ AI Family - æ™ºèƒ½åŒ–M4å®å¤„ç†å’Œè„šæœ¬ç”Ÿæˆç³»ç»Ÿ</p>
            <p class="m4-subtitle">è”ç³»é‚®ç®±: admin@0379.email</p>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="m4-stats">
            <div class="stat-card">
                <div class="stat-value" id="total-templates">5</div>
                <div class="stat-label">å¯ç”¨æ¨¡æ¿</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-generated">0</div>
                <div class="stat-label">å·²ç”Ÿæˆè„šæœ¬</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="success-rate">100%</div>
                <div class="stat-label">æˆåŠŸç‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="last-update">--</div>
                <div class="stat-label">æœ€åæ›´æ–°</div>
            </div>
        </div>

        <!-- æ¨¡æ¿é€‰æ‹© -->
        <div class="m4-section">
            <h3>ğŸ“‹ é€‰æ‹©æ¨¡æ¿</h3>
            <div class="template-list" id="template-list">
                <div class="template-card" data-template="web_deployment">
                    <div class="template-name">ğŸŒ Webåº”ç”¨éƒ¨ç½²</div>
                    <div class="template-description">å®Œæ•´çš„Webåº”ç”¨éƒ¨ç½²è„šæœ¬ï¼ŒåŒ…å«å¤‡ä»½ã€æ„å»ºã€éƒ¨ç½²ç­‰æ­¥éª¤</div>
                    <div class="template-category">éƒ¨ç½²</div>
                </div>
                <div class="template-card" data-template="api_service">
                    <div class="template-name">ğŸš€ APIæœåŠ¡</div>
                    <div class="template-description">Express.js APIæœåŠ¡æ¨¡æ¿ï¼ŒåŒ…å«å¥åº·æ£€æŸ¥å’Œå®‰å…¨é…ç½®</div>
                    <div class="template-category">API</div>
                </div>
                <div class="template-card" data-template="docker_container">
                    <div class="template-name">ğŸ³ Dockerå®¹å™¨</div>
                    <div class="template-description">ä¼˜åŒ–çš„Dockerå®¹å™¨æ¨¡æ¿ï¼Œæ”¯æŒå¤šé˜¶æ®µæ„å»ºå’Œå®‰å…¨é…ç½®</div>
                    <div class="template-category">å®¹å™¨åŒ–</div>
                </div>
                <div class="template-card" data-template="database_migration">
                    <div class="template-name">ğŸ—„ï¸ æ•°æ®åº“è¿ç§»</div>
                    <div class="template-description">æ•°æ®åº“è¿ç§»è„šæœ¬æ¨¡æ¿ï¼Œæ”¯æŒå¤‡ä»½å’Œå›æ»šåŠŸèƒ½</div>
                    <div class="template-category">æ•°æ®åº“</div>
                </div>
                <div class="template-card" data-template="monitoring_script">
                    <div class="template-name">ğŸ‘ï¸ ç›‘æ§è„šæœ¬</div>
                    <div class="template-description">æœåŠ¡ç›‘æ§è„šæœ¬ï¼ŒåŒ…å«å¥åº·æ£€æŸ¥å’Œå‘Šè­¦åŠŸèƒ½</div>
                    <div class="template-category">ç›‘æ§</div>
                </div>
            </div>
        </div>

        <!-- é…ç½®åŒºåŸŸ -->
        <div class="m4-controls">
            <div class="m4-section">
                <h3>âš™ï¸ åŸºç¡€é…ç½®</h3>
                <div class="form-group">
                    <label>æœåŠ¡åç§° *</label>
                    <input type="text" id="service-name" placeholder="ä¾‹å¦‚: my-web-app" value="yyc3-demo-app">
                </div>
                <div class="form-group">
                    <label>ç«¯å£å· *</label>
                    <input type="number" id="port" placeholder="ä¾‹å¦‚: 3000" value="6600">
                </div>
                <div class="form-group">
                    <label>åŸŸå</label>
                    <input type="text" id="domain" placeholder="ä¾‹å¦‚: example.com" value="0379.email">
                </div>
                <div class="form-group">
                    <label>ç¯å¢ƒ</label>
                    <select id="environment">
                        <option value="development">å¼€å‘ç¯å¢ƒ</option>
                        <option value="staging">æµ‹è¯•ç¯å¢ƒ</option>
                        <option value="production" selected>ç”Ÿäº§ç¯å¢ƒ</option>
                    </select>
                </div>
            </div>

            <div class="m4-section">
                <h3>ğŸ”§ é«˜çº§é…ç½®</h3>
                <div class="form-group">
                    <label>Gitä»“åº“åœ°å€</label>
                    <input type="text" id="git-repo" placeholder="https://github.com/user/repo.git" value="https://github.com/YYC-Cube/yyc3-smart-script-manager.git">
                </div>
                <div class="form-group">
                    <label>éƒ¨ç½²ç”¨æˆ·</label>
                    <input type="text" id="deploy-user" placeholder="deploy" value="admin@0379.email">
                </div>
                <div class="form-group">
                    <label>å¤‡ä»½è·¯å¾„</label>
                    <input type="text" id="backup-path" placeholder="/var/backups" value="/var/backups/yyc3">
                </div>
                <div class="form-group">
                    <label>å¯ç”¨SSL</label>
                    <select id="enable-ssl">
                        <option value="true">æ˜¯</option>
                        <option value="false">å¦</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- ç”ŸæˆæŒ‰é’® -->
        <div style="text-align: center; margin: 2rem 0;">
            <button class="btn" id="generate-btn" onclick="generateScript()">
                ğŸ”§ ç”Ÿæˆè„šæœ¬
            </button>
            <button class="btn btn-success" id="save-btn" onclick="saveScript()" style="margin-left: 1rem;" disabled>
                ğŸ’¾ ä¿å­˜è„šæœ¬
            </button>
        </div>

        <!-- ç»“æœåŒºåŸŸ -->
        <div class="result-section" id="result-section" style="display: none;">
            <h3>ğŸ“„ ç”Ÿæˆçš„è„šæœ¬</h3>
            <div id="result-message"></div>
            <textarea class="generated-script" id="generated-script" readonly></textarea>
            <div style="margin-top: 1rem; text-align: center;">
                <button class="btn" onclick="copyScript()">ğŸ“‹ å¤åˆ¶è„šæœ¬</button>
                <button class="btn btn-success" onclick="downloadScript()" style="margin-left: 1rem;">
                    â¬‡ï¸ ä¸‹è½½è„šæœ¬
                </button>
            </div>
        </div>
    </div>

    <script>
        let selectedTemplate = null;
        let currentGeneratedScript = null;
        let currentFileName = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            setupTemplateSelection();
            setupRealtimeClock();
        });

        // è®¾ç½®æ¨¡æ¿é€‰æ‹©
        function setupTemplateSelection() {
            const templateCards = document.querySelectorAll('.template-card');
            templateCards.forEach(card => {
                card.addEventListener('click', () => {
                    templateCards.forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    selectedTemplate = card.dataset.template;
                    updateFormForTemplate(selectedTemplate);
                });
            });
        }

        // æ ¹æ®æ¨¡æ¿æ›´æ–°è¡¨å•
        function updateFormForTemplate(templateName) {
            // æ ¹æ®ä¸åŒæ¨¡æ¿è®¾ç½®é»˜è®¤å€¼
            const defaults = {
                web_deployment: {
                    service_name: 'my-web-app',
                    port: '3000',
                    domain: 'example.com'
                },
                api_service: {
                    service_name: 'my-api',
                    port: '3001',
                    domain: 'api.example.com'
                },
                docker_container: {
                    service_name: 'my-app-container',
                    port: '8080',
                    domain: ''
                },
                database_migration: {
                    service_name: 'database-migration',
                    port: '5432',
                    domain: ''
                },
                monitoring_script: {
                    service_name: 'service-monitor',
                    port: '80',
                    domain: 'example.com'
                }
            };

            const config = defaults[templateName];
            if (config) {
                document.getElementById('service-name').value = config.service_name;
                document.getElementById('port').value = config.port;
                document.getElementById('domain').value = config.domain;
            }
        }

        // ç”Ÿæˆè„šæœ¬
        async function generateScript() {
            if (!selectedTemplate) {
                showMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¨¡æ¿', 'error');
                return;
            }

            const generateBtn = document.getElementById('generate-btn');
            generateBtn.disabled = true;
            generateBtn.textContent = 'â³ ç”Ÿæˆä¸­...';

            try {
                const variables = collectVariables();

                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        templateName: selectedTemplate,
                        variables: variables,
                        filename: generateFileName()
                    })
                });

                const result = await response.json();

                if (result.success) {
                    displayGeneratedScript(result.content);
                    showMessage('è„šæœ¬ç”ŸæˆæˆåŠŸï¼', 'success');
                    currentGeneratedScript = result.content;
                    currentFileName = generateFileName();
                    updateStats();
                } else {
                    showMessage('è„šæœ¬ç”Ÿæˆå¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'ğŸ”§ ç”Ÿæˆè„šæœ¬';
            }
        }

        // æ”¶é›†å˜é‡
        function collectVariables() {
            return {
                service_name: document.getElementById('service-name').value,
                port: document.getElementById('port').value,
                domain: document.getElementById('domain').value,
                environment: document.getElementById('environment').value,
                git_repo: document.getElementById('git-repo').value,
                deploy_user: document.getElementById('deploy-user').value,
                backup_path: document.getElementById('backup-path').value,
                enable_ssl: document.getElementById('enable-ssl').value,
                redis_host: document.getElementById('domain').value,
                redis_port: '6379'
            };
        }

        // ç”Ÿæˆæ–‡ä»¶å
        function generateFileName() {
            const serviceName = document.getElementById('service-name').value || 'generated';
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
            return `${serviceName}-${timestamp}.sh`;
        }

        // æ˜¾ç¤ºç”Ÿæˆçš„è„šæœ¬
        function displayGeneratedScript(content) {
            const resultSection = document.getElementById('result-section');
            const generatedScript = document.getElementById('generated-script');
            const saveBtn = document.getElementById('save-btn');

            resultSection.style.display = 'block';
            generatedScript.value = content;
            saveBtn.disabled = false;

            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }

        // å¤åˆ¶è„šæœ¬
        function copyScript() {
            const textarea = document.getElementById('generated-script');
            textarea.select();
            document.execCommand('copy');
            showMessage('è„šæœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        }

        // ä¸‹è½½è„šæœ¬
        function downloadScript() {
            if (!currentGeneratedScript || !currentFileName) {
                showMessage('æ²¡æœ‰å¯ä¸‹è½½çš„è„šæœ¬', 'error');
                return;
            }

            const blob = new Blob([currentGeneratedScript], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showMessage('è„šæœ¬ä¸‹è½½æˆåŠŸ', 'success');
        }

        // ä¿å­˜è„šæœ¬
        async function saveScript() {
            if (!currentGeneratedScript || !currentFileName) {
                showMessage('æ²¡æœ‰å¯ä¿å­˜çš„è„šæœ¬', 'error');
                return;
            }

            try {
                const response = await fetch('/api/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: currentGeneratedScript,
                        filename: currentFileName
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('è„šæœ¬ä¿å­˜æˆåŠŸ: ' + result.path, 'success');
                } else {
                    showMessage('è„šæœ¬ä¿å­˜å¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type) {
            const resultSection = document.getElementById('result-section');
            const messageDiv = document.getElementById('result-message');

            messageDiv.className = type;
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';

            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }

        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();

                document.getElementById('total-generated').textContent = stats.totalGenerated || 0;

                if (stats.lastGenerated) {
                    const lastUpdate = new Date(stats.lastGenerated);
                    document.getElementById('last-update').textContent = lastUpdate.toLocaleTimeString('zh-CN');
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const totalGeneratedEl = document.getElementById('total-generated');
            let currentCount = parseInt(totalGeneratedEl.textContent) || 0;
            totalGeneratedEl.textContent = currentCount + 1;

            const now = new Date();
            document.getElementById('last-update').textContent = now.toLocaleTimeString('zh-CN');
        }

        // è®¾ç½®å®æ—¶æ—¶é’Ÿ
        function setupRealtimeClock() {
            const updateTime = () => {
                const now = new Date();
                const timeString = now.toLocaleTimeString('zh-CN', {
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                const dateString = now.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });

                // å¦‚æœé¡µé¢ä¸Šæœ‰æ—¶é—´æ˜¾ç¤ºå…ƒç´ ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ›´æ–°
                console.log(`å½“å‰æ—¶é—´: ${dateString} ${timeString}`);
            };

            updateTime();
            setInterval(updateTime, 1000);
        }
    </script>
</body>
</html>