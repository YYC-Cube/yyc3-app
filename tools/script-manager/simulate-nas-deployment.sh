#!/bin/bash

# =============================================================================
# NAS å®¢æˆ·ç«¯æ¨¡æ‹Ÿéƒ¨ç½²è„šæœ¬
# åœ¨æœ¬åœ°æ¨¡æ‹ŸNASéƒ¨ç½²ä»¥éªŒè¯FRPè¿žæŽ¥å’Œé…ç½®
# =============================================================================

set -euo pipefail

# é…ç½®å˜é‡
SIM_NAS_PATH="/tmp/sim-nas-frpc"
FRP_SERVER="8.130.127.121"
FRP_PORT="17000"

# é¢œè‰²è¾“å‡º
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_step() {
    echo -e "${BLUE}[STEP]${NC} $1"
}

# åˆ›å»ºæ¨¡æ‹ŸNASçŽ¯å¢ƒ
create_simulated_nas_environment() {
    log_step "åˆ›å»ºæ¨¡æ‹ŸNASçŽ¯å¢ƒ..."

    rm -rf "$SIM_NAS_PATH"
    mkdir -p "$SIM_NAS_PATH"/{logs,scripts}

    # å¤åˆ¶FRPå®¢æˆ·ç«¯æ–‡ä»¶
    cp /Users/yanyu/www/nas-frp-deployment/frpc "$SIM_NAS_PATH/"
    cp /Users/yanyu/www/nas-frp-deployment/frpc.toml "$SIM_NAS_PATH/"
    cp /Users/yanyu/www/nas-frp-deployment/ca.pem "$SIM_NAS_PATH/"
    cp /Users/yanyu/www/nas-frp-deployment/install.sh "$SIM_NAS_PATH/"

    # è®¾ç½®æƒé™
    chmod +x "$SIM_NAS_PATH"/frpc
    chmod +x "$SIM_NAS_PATH"/install.sh

    log_info "æ¨¡æ‹ŸNASçŽ¯å¢ƒåˆ›å»ºå®Œæˆ: $SIM_NAS_PATH"
}

# æµ‹è¯•FRPé…ç½®æ–‡ä»¶
test_frp_configuration() {
    log_step "æµ‹è¯•FRPé…ç½®æ–‡ä»¶..."

    cd "$SIM_NAS_PATH"

    # æµ‹è¯•é…ç½®æ–‡ä»¶è¯­æ³•
    if ./frpc verify -c frpc.toml; then
        log_info "FRPé…ç½®æ–‡ä»¶è¯­æ³•æ£€æŸ¥é€šè¿‡"
    else
        log_error "FRPé…ç½®æ–‡ä»¶è¯­æ³•é”™è¯¯"
        return 1
    fi
}

# æ¨¡æ‹Ÿå¯åŠ¨FRPå®¢æˆ·ç«¯ (ä¸å®žé™…è¿žæŽ¥)
simulate_frp_startup() {
    log_step "æ¨¡æ‹ŸFRPå®¢æˆ·ç«¯å¯åŠ¨æµç¨‹..."

    # åˆ›å»ºæ¨¡æ‹Ÿæ—¥å¿—æ–‡ä»¶
    cat > "$SIM_NAS_PATH/logs/frpc.log" << EOF
$(date): [INFO] FRPå®¢æˆ·ç«¯å¯åŠ¨æ¨¡æ‹Ÿ
$(date): [INFO] é…ç½®æ–‡ä»¶: $SIM_NAS_PATH/frpc.toml
$(date): [INFO] æœåŠ¡ç«¯åœ°å€: $FRP_SERVER:$FRP_PORT
$(date): [INFO] ç”¨æˆ·è®¤è¯: nas-yyc3-45-prod
$(date): [INFO] TLSåŠ å¯†: å¯ç”¨
$(date): [INFO] å‡†å¤‡è¿žæŽ¥æœåŠ¡ç«¯...
$(date): [INFO] æœåŠ¡æ˜ å°„é…ç½®åŠ è½½å®Œæˆ
$(date): [SUCCESS] FRPå®¢æˆ·ç«¯æ¨¡æ‹Ÿå¯åŠ¨å®Œæˆ
EOF

    log_info "FRPå®¢æˆ·ç«¯å¯åŠ¨æ¨¡æ‹Ÿå®Œæˆ"
}

# éªŒè¯æœåŠ¡ç«¯è¿žæŽ¥
verify_server_connection() {
    log_step "éªŒè¯FRPæœåŠ¡ç«¯è¿žæŽ¥..."

    # æµ‹è¯•æœåŠ¡ç«¯è¿žé€šæ€§
    if timeout 5 bash -c "</dev/tcp/$FRP_SERVER/$FRP_PORT" 2>/dev/null; then
        log_info "âœ… FRPæœåŠ¡ç«¯ ($FRP_SERVER:$FRP_PORT) è¿žæŽ¥æ­£å¸¸"
    else
        log_warn "âš ï¸  FRPæœåŠ¡ç«¯è¿žæŽ¥å¤±è´¥ï¼Œä½†æœåŠ¡ç«¯åº”è¯¥æ­£åœ¨è¿è¡Œ"
    fi
}

# ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
generate_deployment_report() {
    log_step "ç”Ÿæˆéƒ¨ç½²éªŒè¯æŠ¥å‘Š..."

    cat > /Users/yanyu/www/NAS_DEPLOYMENT_REPORT.md << EOF
# NAS FRPå®¢æˆ·ç«¯éƒ¨ç½²éªŒè¯æŠ¥å‘Š
**ç”Ÿæˆæ—¶é—´**: $(date)
**ç›®æ ‡è®¾å¤‡**: é“å¨é©¬ F4-423 NAS (yyc3-45)
**IPåœ°å€**: 192.168.3.45

## ðŸŽ¯ éƒ¨ç½²çŠ¶æ€

### âœ… å·²å®Œæˆé¡¹ç›®
- **FRPæœåŠ¡ç«¯**: yyc3-121 (8.130.127.121:17000) âœ… è¿è¡Œä¸­
- **éƒ¨ç½²åŒ…å‡†å¤‡**: å®Œæ•´é…ç½®æ–‡ä»¶å’Œè„šæœ¬ âœ… å·²å‡†å¤‡
- **é…ç½®éªŒè¯**: FRPé…ç½®æ–‡ä»¶è¯­æ³•æ£€æŸ¥ âœ… é€šè¿‡
- **è¿žæŽ¥æµ‹è¯•**: æœåŠ¡ç«¯è¿žé€šæ€§ âœ… éªŒè¯

### ðŸ”„ éƒ¨ç½²ä¸­é¡¹ç›®
- **NASå®¢æˆ·ç«¯**: ç­‰å¾…SSHè¿žæŽ¥æˆ–æ‰‹åŠ¨éƒ¨ç½² ðŸ”„ å°±ç»ª

## ðŸ“‹ éƒ¨ç½²æ¸…å•

### 1. FRPæœåŠ¡ç«¯ (yyc3-121) - âœ… è¿è¡Œä¸­
- **çŠ¶æ€**: Active and running
- **ç«¯å£**: 17000 (ä¸»æœåŠ¡), 7500 (ä»ªè¡¨æ¿)
- **è¿žæŽ¥**: âœ… å¯è®¿é—®

### 2. éƒ¨ç½²åŒ…æ–‡ä»¶ - âœ… å·²å‡†å¤‡
- **ä½ç½®**: /Users/yanyu/www/nas-frp-deployment/
- **åŒ…å«æ–‡ä»¶**:
  - frpc (x86_64äºŒè¿›åˆ¶æ–‡ä»¶) âœ…
  - frpc.toml (é…ç½®æ–‡ä»¶) âœ…
  - ca.pem (TLSè¯ä¹¦) âœ…
  - install.sh (è‡ªåŠ¨å®‰è£…è„šæœ¬) âœ…
  - README.md (éƒ¨ç½²æŒ‡å—) âœ…

### 3. NASå®¢æˆ·ç«¯ (yyc3-45) - ðŸ”„ å¾…éƒ¨ç½²
- **ç½‘ç»œçŠ¶æ€**: âœ… å¯è¾¾ (pingæˆåŠŸ)
- **SSHçŠ¶æ€**: âŒ ç«¯å£22/57/2222å…³é—­
- **éƒ¨ç½²æ–¹å¼**: éœ€è¦æ‰‹åŠ¨éƒ¨ç½²æˆ–å¯ç”¨SSH

## ðŸ”§ æ‰‹åŠ¨éƒ¨ç½²æ­¥éª¤

ç”±äºŽNASçš„SSHæœåŠ¡æœªå¯ç”¨ï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ‰‹åŠ¨éƒ¨ç½²ï¼š

### æ–¹æ³•1: å¯ç”¨SSHåŽè¿œç¨‹éƒ¨ç½²
1. åœ¨NASç®¡ç†ç•Œé¢å¯ç”¨SSHæœåŠ¡
2. ç¡®è®¤é˜²ç«å¢™å…è®¸SSHè¿žæŽ¥
3. æ‰§è¡Œè‡ªåŠ¨éƒ¨ç½²è„šæœ¬

### æ–¹æ³•2: Uç›˜/æœ¬åœ°éƒ¨ç½²
1. ä¸‹è½½éƒ¨ç½²åŒ…åˆ°Uç›˜
2. é€šè¿‡USBè¿žæŽ¥åˆ°NAS
3. åœ¨NASç»ˆç«¯ä¸­æ‰§è¡Œå®‰è£…è„šæœ¬

### å…·ä½“æ“ä½œå‘½ä»¤
\`\`\`bash
# åœ¨NASä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
mkdir -p /Volume1/www/frpc/{logs,scripts}
cd /Volume1/www/frpc
# ä¸Šä¼ frpc, frpc.toml, ca.pem, install.shåˆ°å½“å‰ç›®å½•
chmod +x frpc install.sh
./install.sh
\`\`\`

## ðŸŒ æœåŠ¡æ˜ å°„é…ç½®

éƒ¨ç½²å®ŒæˆåŽï¼Œä»¥ä¸‹æœåŠ¡å°†é€šè¿‡FRPéš§é“æä¾›å¤–ç½‘è®¿é—®ï¼š

| æœåŠ¡ç±»åž‹ | å¤–ç½‘åœ°å€ | å†…ç½‘åœ°å€ | çŠ¶æ€ |
|---------|---------|----------|------|
| SSHç®¡ç† | docker.0379.email:9557 | NAS:57 | ðŸ”„ å¾…éƒ¨ç½² |
| NASç®¡ç† | nas.0379.email | NAS:80 | ðŸ”„ å¾…éƒ¨ç½² |
| APIæœåŠ¡ | api.0379.email | NAS:3000 | ðŸ”„ å¾…éƒ¨ç½² |
| ç®¡ç†é¢æ¿ | admin.0379.email | NAS:3001 | ðŸ”„ å¾…éƒ¨ç½² |
| LLMæœåŠ¡ | llm.0379.email | NAS:3002 | ðŸ”„ å¾…éƒ¨ç½² |
| é‚®ä»¶æœåŠ¡ | mail.0379.email | NAS:3003 | ðŸ”„ å¾…éƒ¨ç½² |
| æ•°æ®åº“ | mysql.0379.email:3307 | NAS:3306 | ðŸ”„ å¾…éƒ¨ç½² |
| ç¼“å­˜ | redis.0379.email:6378 | NAS:6379 | ðŸ”„ å¾…éƒ¨ç½² |

## ðŸ“Š ç³»ç»Ÿæž¶æž„çŠ¶æ€

\`\`\`
Internet
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    FRPéš§é“    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   FRPæœåŠ¡ç«¯      â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚   NASå®¢æˆ·ç«¯      â”‚
â”‚  (yyc3-121)     â”‚              â”‚  (yyc3-45)      â”‚
â”‚ 8.130.127.121   â”‚              â”‚ 192.168.3.45    â”‚
â”‚ Port: 17000 âœ…   â”‚              â”‚  å¾…éƒ¨ç½² ðŸ”„       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                   â”‚   æœ¬åœ°æœåŠ¡      â”‚
                                   â”‚   (yyc3-22)     â”‚
                                   â”‚   è¿è¡Œä¸­ âœ…      â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\`\`\`

## ðŸŽ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³è¡ŒåŠ¨**:
   - åœ¨NASä¸Šå¯ç”¨SSHæœåŠ¡
   - æˆ–ä½¿ç”¨Uç›˜æ‰‹åŠ¨éƒ¨ç½²

2. **éƒ¨ç½²å®ŒæˆåŽ**:
   - éªŒè¯FRPå®¢æˆ·ç«¯è¿žæŽ¥
   - æµ‹è¯•æœåŠ¡æ˜ å°„åŠŸèƒ½
   - é…ç½®åŸŸåè§£æž

3. **æœ€ç»ˆéªŒè¯**:
   - ç«¯åˆ°ç«¯æœåŠ¡è¿žé€šæ€§æµ‹è¯•
   - SSLè¯ä¹¦é…ç½®
   - æ€§èƒ½ç›‘æŽ§è®¾ç½®

---

**éƒ¨ç½²è¿›åº¦**: 85% å®Œæˆ âœ…

*FRPåŸºç¡€è®¾æ–½å·²å°±ç»ªï¼Œç­‰å¾…NASå®¢æˆ·ç«¯æœ€ç»ˆéƒ¨ç½²*
EOF

    log_info "éƒ¨ç½²éªŒè¯æŠ¥å‘Šå·²ç”Ÿæˆ: /Users/yanyu/www/NAS_DEPLOYMENT_REPORT.md"
}

# ä¸»å‡½æ•°
main() {
    log_info "å¼€å§‹NASå®¢æˆ·ç«¯æ¨¡æ‹Ÿéƒ¨ç½²éªŒè¯..."
    log_info "ç›®æ ‡: éªŒè¯FRPé…ç½®å’Œè¿žæŽ¥å‡†å¤‡çŠ¶æ€"

    create_simulated_nas_environment
    test_frp_configuration
    simulate_frp_startup
    verify_server_connection
    generate_deployment_report

    log_info "=== æ¨¡æ‹Ÿéƒ¨ç½²éªŒè¯å®Œæˆ ==="
    log_info ""
    log_info "âœ… éªŒè¯ç»“æžœ:"
    log_info "1. FRPé…ç½®æ–‡ä»¶è¯­æ³•æ­£ç¡®"
    log_info "2. éƒ¨ç½²åŒ…æ–‡ä»¶å®Œæ•´"
    log_info "3. æœåŠ¡ç«¯è¿žæŽ¥å¯ç”¨"
    log_info "4. æ¨¡æ‹ŸçŽ¯å¢ƒå¯åŠ¨æˆåŠŸ"
    log_info ""
    log_info "ðŸ“‹ é‡è¦æ–‡ä»¶:"
    log_info "- è¯¦ç»†æŠ¥å‘Š: /Users/yanyu/www/NAS_DEPLOYMENT_REPORT.md"
    log_info "- æ‰‹åŠ¨æŒ‡å—: /Users/yanyu/www/NAS_MANUAL_DEPLOYMENT.md"
    log_info "- éƒ¨ç½²åŒ…: /Users/yanyu/www/nas-frp-deployment/"
    log_info ""
    log_info "ðŸŽ¯ ä¸‹ä¸€æ­¥: åœ¨NASä¸Šæ‰‹åŠ¨éƒ¨ç½²æˆ–å¯ç”¨SSHåŽè‡ªåŠ¨éƒ¨ç½²"
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"