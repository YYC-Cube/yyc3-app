#!/bin/bash
# ======================================================
# 微服务部署健康检查与回滚机制配置示例
# ======================================================
# 注意: 复制此文件为 config.env 并根据实际情况修改配置
# ======================================================

# 核心配置
# ------------------------------------------------------
SERVICE_NAME="api-gateway"        # 服务名称
DEPLOY_ENV="staging"              # 部署环境: dev/staging/prod
SERVICE_DIR="/opt/api-gateway"    # 服务部署目录

# 健康检查配置
# ------------------------------------------------------
HEALTH_CHECK_URL="https://staging-api.example.com/api/health"  # 健康检查URL
HEALTH_CHECK_TIMEOUT=30           # 健康检查超时时间(秒)
HEALTH_CHECK_RETRIES=5            # 健康检查重试次数
HEALTH_CHECK_INTERVAL=5           # 健康检查间隔(秒)
DEPLOYMENT_TIMEOUT=300            # 部署总超时时间(秒)

# 检查控制
# ------------------------------------------------------
PRE_DEPLOY_CHECKS=true            # 是否执行部署前检查
POST_DEPLOY_CHECKS=true           # 是否执行部署后检查
AUTO_ROLLBACK=true                # 是否自动回滚
ROLLBACK_TIMEOUT=120              # 回滚超时时间(秒)
LOG_LEVEL="info"                  # 日志级别: debug/info/warn/error

# 备份配置
# ------------------------------------------------------
BACKUP_ENABLED=true               # 是否启用备份
BACKUP_DIR="/var/backups/api-gateway/staging"  # 备份目录

# 部署命令（自定义）
# ------------------------------------------------------
DEPLOY_COMMAND="
  # 拉取最新代码
  cd /opt/api-gateway && git pull origin main
  
  # 安装依赖
  npm install --production
  
  # 构建应用
  npm run build
  
  # 重启服务（示例）
  sudo systemctl restart api-gateway
"

# 服务控制命令（自定义）
# ------------------------------------------------------
STOP_COMMAND="sudo systemctl stop api-gateway"
START_COMMAND="sudo systemctl start api-gateway"

# 依赖服务配置（格式: "service1:host1:port1 service2:host2:port2"）
# ------------------------------------------------------
DEPENDENCIES="
  redis:redis.example.com:6379
  postgres:db.example.com:5432
  auth-service:auth.example.com:3001
"

# 性能监控配置
# ------------------------------------------------------
MONITORING_ENABLED=true           # 是否启用监控通知
METRICS_URL="https://staging-api.example.com/api/metrics"  # 性能指标URL
METRICS_THRESHOLD_CPU=80          # CPU使用率阈值(%)
METRICS_THRESHOLD_MEMORY=85       # 内存使用率阈值(%)

# 冒烟测试配置（可选）
# ------------------------------------------------------
SMOKE_TESTS="
  #!/bin/bash
  
  echo '开始冒烟测试...'
  
  # 测试健康检查端点
  health_status=$(curl -s -o /dev/null -w "%{http_code}" https://staging-api.example.com/api/health)
  if [ "$health_status" -ne 200 ]; then
    echo "健康检查失败: $health_status"
    exit 1
  fi
  
  # 测试核心API端点
  api_status=$(curl -s -o /dev/null -w "%{http_code}" https://staging-api.example.com/api/users)
  if [ "$api_status" -ne 200 ] && [ "$api_status" -ne 401 ]; then
    echo "API测试失败: $api_status"
    exit 1
  fi
  
  echo '冒烟测试通过!'
  exit 0
"

# 通知配置
# ------------------------------------------------------
# Slack通知配置
SLACK_WEBHOOK="YOUR_SLACK_WEBHOOK_URL_HERE"

# Discord通知配置
DISCORD_WEBHOOK="YOUR_DISCORD_WEBHOOK_URL_HERE"

# 邮件通知配置
EMAIL_NOTIFICATION="devops@example.com"
