# SSH密钥同步工具使用指南

## 工具概述

此工具用于将不同操作系统下的默认SSH密钥路径中的密钥文件同步至SSH配置文件中定义的预设路径。支持多种同步模式和系统类型，实现密钥管理的标准化。

## 功能特点

- **自动检测系统类型**：支持 macOS、Linux 和 Windows 系统
- **智能选择密钥类型**：优先使用更安全的 ED25519 类型密钥
- **双同步模式**：支持复制模式和符号链接模式
- **配置文件解析**：自动从 SSH 配置文件提取自定义密钥路径
- **权限自动设置**：确保所有密钥文件具有正确的访问权限
- **完整日志输出**：详细的操作日志和状态摘要
- **备份已有文件**：防止意外覆盖重要文件

## 支持的系统

- **macOS**：自动检测 Darwin 系统
- **Linux**：支持各种 Linux 发行版
- **Windows**：支持通过 WSL 或 Git Bash 使用

## 默认密钥路径

根据系统类型，工具会自动使用以下默认密钥路径：

| 系统 | RSA密钥路径 | ED25519密钥路径（首选） |
|------|------------|------------------------|
| macOS | `~/.ssh/id_rsa` | `~/.ssh/id_ed25519` |
| Linux | `~/.ssh/id_rsa` | `~/.ssh/id_ed25519` |
| Windows | `~/.ssh/id_rsa` | `~/.ssh/id_ed25519` |

## 同步模式说明

### 1. 复制模式（默认）

- **特点**：将默认密钥完整复制到预设路径
- **优点**：密钥文件相互独立，修改一个不会影响另一个
- **缺点**：占用额外磁盘空间，需要分别维护多个密钥文件
- **适用场景**：需要为不同环境维护不同密钥内容的情况

### 2. 符号链接模式

- **特点**：为默认密钥创建符号链接到预设路径
- **优点**：节省磁盘空间，修改一次即可更新所有链接
- **缺点**：所有链接指向同一个密钥文件，无法单独定制
- **适用场景**：所有环境可以使用相同密钥内容的情况

## 使用方法

### 基本使用

执行默认同步（复制模式，使用 `~/.ssh/config`）：

```bash
./sync-ssh-keys.sh
```

### 指定同步模式

使用链接模式同步密钥：

```bash
./sync-ssh-keys.sh --mode link
```

### 使用自定义配置文件

如果您的 SSH 配置文件不在默认位置：

```bash
./sync-ssh-keys.sh --config /path/to/your/ssh/config
```

### 组合选项

```bash
./sync-ssh-keys.sh --config /path/to/custom/config --mode link
```

## 工作原理

1. **系统检测**：自动识别当前操作系统类型
2. **密钥检测**：查找并使用最安全的可用默认密钥
3. **配置解析**：从 SSH 配置文件中提取所有 `IdentityFile` 路径
4. **密钥同步**：根据选择的模式复制或链接密钥文件
5. **权限设置**：确保所有密钥文件具有正确的访问权限
6. **状态报告**：显示同步结果和密钥状态摘要

## 示例场景

### 场景1：新设备初始化

当您在新设备上设置开发环境时，可以：

1. 生成默认 SSH 密钥（如果尚未存在）
2. 将此工具和您的 SSH 配置文件复制到新设备
3. 运行同步工具：`./sync-ssh-keys.sh`
4. 所有预设路径的密钥将自动创建并配置好权限

### 场景2：统一多设备密钥管理

在多台设备间保持一致的密钥设置：

1. 在主设备上生成和管理默认密钥
2. 将默认密钥复制到其他设备的默认路径
3. 在每台设备上运行同步工具
4. 所有设备将拥有相同的密钥配置

### 场景3：更换默认密钥

当需要更新 SSH 密钥时：

1. 生成新的默认密钥
2. 运行同步工具：`./sync-ssh-keys.sh --mode copy`
3. 所有预设路径将使用新的密钥内容更新

## 注意事项

1. **权限要求**：请确保您有足够权限访问和修改 `~/.ssh` 目录及相关文件
2. **密钥备份**：在运行工具前，建议备份重要的自定义密钥文件
3. **覆盖警告**：工具会在覆盖文件前创建备份，但仍请谨慎操作
4. **配置有效性**：请确保您的 SSH 配置文件格式正确，包含有效的 `IdentityFile` 条目
5. **Windows 兼容性**：在 Windows 上使用时，建议通过 WSL 或 Git Bash 运行

## 故障排除

### 问题1：找不到配置文件

如果工具无法找到 SSH 配置文件，它会使用硬编码的预设密钥路径列表：

- `~/.ssh/id_rsa_local`
- `~/.ssh/id_rsa_aliyun`
- `~/.ssh/id_rsa_dev`
- `~/.ssh/id_rsa_prod`
- `~/.ssh/id_rsa_github_cube`
- `~/.ssh/id_rsa_github_neuxs`
- `~/.ssh/id_rsa_docker`

### 问题2：权限错误

如果遇到权限相关错误，请确保：

1. `~/.ssh` 目录权限为 700
2. 所有密钥文件权限为 600
3. 所有公钥文件权限为 644

您可以手动设置这些权限：

```bash
chmod 700 ~/.ssh
chmod 600 ~/.ssh/id_rsa*
chmod 644 ~/.ssh/id_rsa*.pub
```

## 安全建议

1. **定期更新密钥**：建议每 3-6 个月更换一次 SSH 密钥
2. **使用 ED25519 类型**：此类型密钥更安全且性能更好
3. **为不同环境使用不同密钥**：考虑使用复制模式为不同系统/环境维护独立密钥
4. **启用 SSH 代理**：使用 `ssh-agent` 管理多个密钥，避免频繁输入密码
5. **禁用密码登录**：在服务器上配置仅允许密钥认证

## 扩展功能

您可以将此脚本集成到系统启动流程或自动化部署脚本中，实现：

1. **设备自动配置**：新设备接入网络后自动设置密钥
2. **CI/CD 集成**：在持续集成环境中自动配置密钥
3. **批量设备管理**：通过远程执行脚本批量同步多台设备的密钥

## 脚本维护

### 更新日志

- **初始版本**：支持基本的密钥同步功能
- **v1.1**：添加 ED25519 密钥支持和系统自动检测
- **v1.2**：添加符号链接模式和详细日志输出

### 自定义修改

如果需要添加更多预设密钥路径或修改行为，可以编辑脚本中的以下部分：

1. **默认密钥映射**：修改 `default_keys` 数组
2. **硬编码预设路径**：修改 `custom_keys` 数组
3. **权限设置**：调整 `chmod` 命令的权限参数

## 常见问题

**Q: 同步后无法连接到服务器怎么办？**

A: 检查以下几点：

1. 密钥权限是否正确（600 对于私钥，644 对于公钥）
2. 服务器是否已添加公钥到 `authorized_keys`
3. 配置文件中的用户名和主机名是否正确

**Q: 如何为不同系统设置不同的默认密钥？**

A: 您可以在脚本中的 `detect_os` 函数后添加条件逻辑，根据系统类型选择不同的默认密钥。

**Q: 符号链接模式在 Windows 上工作吗？**

A: Windows 的符号链接支持取决于具体环境。在 WSL 中可以正常工作，但在原生 Windows 命令提示符中可能需要管理员权限。

---

保持您的 SSH 密钥安全且易于管理！ 🌹
