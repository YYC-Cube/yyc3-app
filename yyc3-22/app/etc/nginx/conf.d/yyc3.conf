# YYC3服务反向代理配置
# 版本：1.0.0
# 创建日期：2024-01-15

# API服务反向代理
server {
    listen 80;
    server_name api.yyc3.local;

    # 访问日志
    access_log /var/log/nginx/api.access.log main;
    error_log /var/log/nginx/api.error.log warn;

    # 限制请求速率
    limit_req zone=mylimit burst=20 nodelay;

    # 静态文件（如果有）
    location /static/ {
        alias /usr/share/nginx/html/static/;
        expires 1d;
    }

    # 动态请求代理到API服务
    location / {
        proxy_pass http://api-server:3000;
        proxy_read_timeout 60s;
        proxy_connect_timeout 60s;

        # 健康检查
        location /health {
            proxy_pass http://api-server:3000/health;
            access_log off;
            add_header Content-Type text/plain;
            return 200 "healthy\n";
        }
    }
}

# Admin服务反向代理
server {
    listen 80;
    server_name admin.yyc3.local;

    # 访问日志
    access_log /var/log/nginx/admin.access.log main;
    error_log /var/log/nginx/admin.error.log warn;

    # 限制请求速率
    limit_req zone=mylimit burst=20 nodelay;

    # 动态请求代理到Admin服务
    location / {
        proxy_pass http://admin-server:3001;
        proxy_read_timeout 60s;
        proxy_connect_timeout 60s;

        # 健康检查
        location /health {
            proxy_pass http://admin-server:3001/health;
            access_log off;
            add_header Content-Type text/plain;
            return 200 "healthy\n";
        }
    }
}

# LLM服务反向代理
server {
    listen 80;
    server_name llm.yyc3.local;

    # 访问日志
    access_log /var/log/nginx/llm.access.log main;
    error_log /var/log/nginx/llm.error.log warn;

    # 限制请求速率
    limit_req zone=mylimit burst=20 nodelay;

    # 动态请求代理到LLM服务
    location / {
        proxy_pass http://llm-server:3002;
        proxy_read_timeout 300s;  # LLM服务可能需要更长时间
        proxy_connect_timeout 60s;

        # 健康检查
        location /health {
            proxy_pass http://llm-server:3002/health;
            access_log off;
            add_header Content-Type text/plain;
            return 200 "healthy\n";
        }
    }
}

# Redis API服务反向代理
server {
    listen 80;
    server_name redis.yyc3.local;

    # 访问日志
    access_log /var/log/nginx/redis.access.log main;
    error_log /var/log/nginx/redis.error.log warn;

    # 限制请求速率
    limit_req zone=mylimit burst=20 nodelay;

    # 动态请求代理到Redis API服务
    location / {
        proxy_pass http://redis-api-server:3101;
        proxy_read_timeout 60s;
        proxy_connect_timeout 60s;

        # 健康检查
        location /health {
            proxy_pass http://redis-api-server:3101/health;
            access_log off;
            add_header Content-Type text/plain;
            return 200 "healthy\n";
        }
    }
}

# Mail服务反向代理
server {
    listen 80;
    server_name mail.yyc3.local;

    # 访问日志
    access_log /var/log/nginx/mail.access.log main;
    error_log /var/log/nginx/mail.error.log warn;

    # 限制请求速率
    limit_req zone=mylimit burst=20 nodelay;

    # 动态请求代理到Mail服务
    location / {
        proxy_pass http://mail-server:3105;
        proxy_read_timeout 60s;
        proxy_connect_timeout 60s;

        # 健康检查
        location /health {
            proxy_pass http://mail-server:3105/health;
            access_log off;
            add_header Content-Type text/plain;
            return 200 "healthy\n";
        }
    }
}

# 监控服务反向代理
server {
    listen 80;
    server_name monitor.yyc3.local;

    # 访问日志
    access_log /var/log/nginx/monitor.access.log main;
    error_log /var/log/nginx/monitor.error.log warn;

    # 限制请求速率
    limit_req zone=mylimit burst=10 nodelay;

    # Prometheus
    location /prometheus/ {
        proxy_pass http://prometheus:9090/;
        proxy_read_timeout 60s;
        proxy_connect_timeout 60s;
    }

    # Grafana
    location /grafana/ {
        proxy_pass http://grafana:3000/;
        proxy_read_timeout 60s;
        proxy_connect_timeout 60s;
    }

    # Loki
    location /loki/ {
        proxy_pass http://loki:3100/;
        proxy_read_timeout 60s;
        proxy_connect_timeout 60s;
    }
}