# ModSecurity主配置文件

# 启用ModSecurity引擎
SecRuleEngine On

# 配置审计日志
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus ^(?:5|4[0-9][0-9])
SecAuditLogParts ABIFHZ
SecAuditLog /var/log/nginx/modsec_audit.log
SecAuditLogType Concurrent

# 配置请求处理
SecRequestBodyAccess On
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyInMemoryLimit 131072
SecRequestBodyLimitAction Reject
SecRule REQUEST_BODY "@rx .*" "id:1000,phase:2,log,deny,status:400,msg:'Body contains illegal characters'"

# 配置响应处理
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml application/json
SecResponseBodyLimit 524288
SecResponseBodyLimitAction ProcessPartial

# 配置规则
SecRuleUpdateActionById 981257 "id:981257,phase:2,pass,nolog,skipAfter:END-REQUEST-981257"

# 配置异常处理
SecDefaultAction "phase:2,log,deny,status:403,msg:'ModSecurity规则匹配'"

# 包含OWASP CRS规则
Include /etc/nginx/modsec/crs/crs-setup.conf
Include /etc/nginx/modsec/crs/rules/*.conf