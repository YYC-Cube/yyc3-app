# IP信誉规则

# 阻止已知恶意IP地址
SecRule REMOTE_ADDR "@ipMatch 192.168.1.100,10.0.0.50" "id:910010,phase:1,log,deny,status:403,msg:'阻止已知恶意IP',tag:'OWASP_CRS/IP_REPUTATION'"

# 限制来自单个IP的请求频率
SecRule REMOTE_ADDR "@ipMatchFromFile /etc/nginx/modsec/crs/data/blacklist.txt" "id:910020,phase:1,log,deny,status:403,msg:'IP在黑名单中',tag:'OWASP_CRS/IP_REPUTATION'"

# 检测并阻止异常的用户代理
SecRule HTTP_USER_AGENT "@rx ^$" "id:910030,phase:1,log,deny,status:403,msg:'空用户代理',tag:'OWASP_CRS/HTTP_PROTOCOL_VIOLATION'"
SecRule HTTP_USER_AGENT "@rx (?:curl|wget|bot|spider|scraper)" "id:910040,phase:1,log,deny,status:403,msg:'自动化工具检测',tag:'OWASP_CRS/BOT_DETECTION'"

# 阻止SQL注入尝试
SecRule REQUEST_URI|ARGS|ARGS_NAMES "@rx (?i)(?:union|select|insert|update|delete|drop|create|alter|truncate|exec)" "id:910050,phase:2,log,deny,status:403,msg:'SQL注入检测',tag:'OWASP_CRS/WEB_ATTACK/SQL_INJECTION'"

# 阻止XSS攻击尝试
SecRule REQUEST_URI|ARGS|ARGS_NAMES "@rx (?i)<script|javascript:|onload|onerror|onclick|alert\(" "id:910060,phase:2,log,deny,status:403,msg:'XSS攻击检测',tag:'OWASP_CRS/WEB_ATTACK/XSS'"

# 阻止命令注入尝试
SecRule REQUEST_URI|ARGS|ARGS_NAMES "@rx (?i)(?:cat|echo|pwd|ls|dir|rm|cp|mv|chmod|chown|bash|sh|cmd|powershell)" "id:910070,phase:2,log,deny,status:403,msg:'命令注入检测',tag:'OWASP_CRS/WEB_ATTACK/COMMAND_INJECTION'"

# 阻止文件路径遍历尝试
SecRule REQUEST_URI|ARGS|ARGS_NAMES "@rx (?i)\.\./|\.\.\\|/etc/passwd|/etc/shadow" "id:910080,phase:2,log,deny,status:403,msg:'文件路径遍历检测',tag:'OWASP_CRS/WEB_ATTACK/PATH_TRAVERSAL'"

# 阻止敏感文件访问尝试
SecRule REQUEST_URI "@rx (?i)\.(?:ini|config|xml|log|bak|old|tmp)$" "id:910090,phase:2,log,deny,status:403,msg:'敏感文件访问检测',tag:'OWASP_CRS/WEB_ATTACK/FILE_INCLUSION'"

# 检测异常的HTTP方法
SecRule REQUEST_METHOD "@rx ^(?:TRACE|TRACK|DEBUG|LINK|UNLINK)$" "id:910100,phase:1,log,deny,status:403,msg:'禁用的HTTP方法',tag:'OWASP_CRS/HTTP_PROTOCOL_VIOLATION'"

# 检测异常的Content-Type
SecRule REQUEST_HEADERS:Content-Type "@rx (?i)multipart/form-data" "id:910110,phase:1,pass,nolog,setvar:tx.multipart_form_data=1"

# 检测过大的请求参数
SecRule ARGS "@rx ^.{1000,}$" "id:910120,phase:2,log,deny,status:403,msg:'过大的请求参数',tag:'OWASP_CRS/WEB_ATTACK/PARAMETER_TAMPERING'"

# 检测SQL注释
SecRule REQUEST_URI|ARGS|ARGS_NAMES "@rx (?i)--|#|/\*" "id:910130,phase:2,log,deny,status:403,msg:'SQL注释检测',tag:'OWASP_CRS/WEB_ATTACK/SQL_INJECTION'"

# 检测XSS特殊字符
SecRule REQUEST_URI|ARGS|ARGS_NAMES "@rx (?i)(?:<|>|'|")" "id:910140,phase:2,log,deny,status:403,msg:'XSS特殊字符检测',tag:'OWASP_CRS/WEB_ATTACK/XSS'"

# 检测JavaScript事件处理器
SecRule REQUEST_URI|ARGS|ARGS_NAMES "@rx (?i)on(?:load|error|click|submit|mouseover|focus|blur|change)" "id:910150,phase:2,log,deny,status:403,msg:'JavaScript事件处理器检测',tag:'OWASP_CRS/WEB_ATTACK/XSS'"

# 检测Base64编码的恶意内容
SecRule REQUEST_URI|ARGS|ARGS_NAMES "@rx (?i)data:text/html|data:text/javascript" "id:910160,phase:2,log,deny,status:403,msg:'Base64编码的恶意内容检测',tag:'OWASP_CRS/WEB_ATTACK/XSS'"

# 检测路径遍历
SecRule REQUEST_URI "@rx (?i)\./\./" "id:910170,phase:2,log,deny,status:403,msg:'路径遍历检测',tag:'OWASP_CRS/WEB_ATTACK/PATH_TRAVERSAL'"

# 检测目录列表访问
SecRule REQUEST_URI "@rx /\.$" "id:910180,phase:2,log,deny,status:403,msg:'目录列表访问检测',tag:'OWASP_CRS/WEB_ATTACK/DIRECTORY_LISTING'"

# 检测服务器端包含
SecRule REQUEST_URI|ARGS|ARGS_NAMES "@rx (?i)<!--#include|<!--#exec" "id:910190,phase:2,log,deny,status:403,msg:'服务器端包含检测',tag:'OWASP_CRS/WEB_ATTACK/SERVER_SIDE_INCLUDE'"

# 检测跨站请求伪造
SecRule REQUEST_METHOD "@rx ^(?:POST|PUT|DELETE)$" "id:910200,phase:2,pass,nolog,chain"
SecRule &REQUEST_HEADERS:Referer "!@eq 1" "id:910210,phase:2,pass,nolog,chain"
SecRule REQUEST_HEADERS:Referer "@rx ^https?://(?:example\.com|www\.example\.com)" "id:910220,phase:2,log,deny,status:403,msg:'CSRF检测',tag:'OWASP_CRS/WEB_ATTACK/CSRF'"

# 检测异常的Cookie
SecRule REQUEST_HEADERS:Cookie "@rx (?i)document\.cookie|javascript:|base64:|eval\(" "id:910230,phase:1,log,deny,status:403,msg:'恶意Cookie检测',tag:'OWASP_CRS/WEB_ATTACK/COOKIE_TAMPERING'"

# 检测HTTP请求走私
SecRule REQUEST_HEADERS "@rx (?i)transfer-encoding|content-length" "id:910240,phase:1,log,deny,status:403,msg:'HTTP请求走私检测',tag:'OWASP_CRS/HTTP_PROTOCOL_VIOLATION'"

# 检测XML外部实体注入
SecRule REQUEST_BODY "@rx (?i)(?:<!DOCTYPE|<!ENTITY)" "id:910250,phase:2,log,deny,status:403,msg:'XXE检测',tag:'OWASP_CRS/WEB_ATTACK/XXE'"

# 检测JSON注入
SecRule REQUEST_BODY "@rx (?i)(?:\\'|\\"|\\\\|\/\*|\*\/)" "id:910260,phase:2,log,deny,status:403,msg:'JSON注入检测',tag:'OWASP_CRS/WEB_ATTACK/JSON_INJECTION'"

# 检测文件上传漏洞
SecRule FILES "@rx (?i)\.(?:php|jsp|asp|aspx|exe|bat|cmd|sh|py|pl)" "id:910270,phase:2,log,deny,status:403,msg:'恶意文件上传检测',tag:'OWASP_CRS/WEB_ATTACK/FILE_UPLOAD'"

# 检测命令执行漏洞
SecRule REQUEST_URI|ARGS|ARGS_NAMES "@rx (?i)(?:\|\||&&|;|\$\(|\`|eval|system|exec|shell_exec|passthru|popen|proc_open)" "id:910280,phase:2,log,deny,status:403,msg:'命令执行检测',tag:'OWASP_CRS/WEB_ATTACK/COMMAND_INJECTION'"

# 检测LDAP注入
SecRule REQUEST_URI|ARGS|ARGS_NAMES "@rx (?i)(?:\(|\)|\||&|=|!|>|<=|>=|<|>|~=|\*|\+|\-|\/)" "id:910290,phase:2,log,deny,status:403,msg:'LDAP注入检测',tag:'OWASP_CRS/WEB_ATTACK/LDAP_INJECTION'"

# 检测XPATH注入
SecRule REQUEST_URI|ARGS|ARGS_NAMES "@rx (?i)(?:\/|\.\.|\*|\[|\]|\(|\)|=|!=|>|>=|<|<=|and|or|not|contains|starts-with|ends-with)" "id:910300,phase:2,log,deny,status:403,msg:'XPATH注入检测',tag:'OWASP_CRS/WEB_ATTACK/XPATH_INJECTION'"

# 检测服务器端请求伪造
SecRule REQUEST_URI|ARGS|ARGS_NAMES "@rx (?i)(?:http|https|ftp|gopher)://(?:localhost|127\.0\.0\.1|0\.0\.0\.0)" "id:910310,phase:2,log,deny,status:403,msg:'SSRF检测',tag:'OWASP_CRS/WEB_ATTACK/SSRF'"

# 检测XXE注入
SecRule REQUEST_BODY "@rx (?i)(?:<!DOCTYPE|<!ENTITY)" "id:910320,phase:2,log,deny,status:403,msg:'XXE检测',tag:'OWASP_CRS/WEB_ATTACK/XXE'"

# 检测安全头缺失
SecRule &RESPONSE_HEADERS:Strict-Transport-Security "!@eq 1" "id:910330,phase:4,log,deny,status:403,msg:'缺少Strict-Transport-Security头',tag:'OWASP_CRS/SECURITY_HEADERS'"
SecRule &RESPONSE_HEADERS:X-Content-Type-Options "!@eq 1" "id:910340,phase:4,log,deny,status:403,msg:'缺少X-Content-Type-Options头',tag:'OWASP_CRS/SECURITY_HEADERS'"
SecRule &RESPONSE_HEADERS:X-Frame-Options "!@eq 1" "id:910350,phase:4,log,deny,status:403,msg:'缺少X-Frame-Options头',tag:'OWASP_CRS/SECURITY_HEADERS'"
SecRule &RESPONSE_HEADERS:X-XSS-Protection "!@eq 1" "id:910360,phase:4,log,deny,status:403,msg:'缺少X-XSS-Protection头',tag:'OWASP_CRS/SECURITY_HEADERS'"

# 检测敏感数据泄露
SecRule RESPONSE_BODY "@rx (?i)(?:password|secret|api_key|access_token|token|auth|credentials|credit_card|ssn|social_security_number)" "id:910370,phase:4,log,deny,status:403,msg:'敏感数据泄露检测',tag:'OWASP_CRS/WEB_ATTACK/SENSITIVE_DATA_DISCLOSURE'"

# 检测响应头中的服务器信息
SecRule RESPONSE_HEADERS:Server "@rx .+" "id:910380,phase:4,log,deny,status:403,msg:'服务器信息泄露',tag:'OWASP_CRS/SECURITY_HEADERS'"
SecRule RESPONSE_HEADERS:X-Powered-By "@rx .+" "id:910390,phase:4,log,deny,status:403,msg:'X-Powered-By头泄露',tag:'OWASP_CRS/SECURITY_HEADERS'"

# 检测错误信息泄露
SecRule RESPONSE_BODY "@rx (?i)(?:error|exception|stack trace|traceback|fatal error|warning|notice|parse error|syntax error)" "id:910400,phase:4,log,deny,status:403,msg:'错误信息泄露',tag:'OWASP_CRS/ERROR_DISCLOSURE'"

# 检测数据库错误信息
SecRule RESPONSE_BODY "@rx (?i)(?:mysql|postgresql|oracle|sql server|sqlite|database|table|column|syntax|query)" "id:910410,phase:4,log,deny,status:403,msg:'数据库错误信息泄露',tag:'OWASP_CRS/ERROR_DISCLOSURE/DATABASE'"

# 检测PHP错误信息
SecRule RESPONSE_BODY "@rx (?i)(?:php|zend|apache|cgi|mod_php)" "id:910420,phase:4,log,deny,status:403,msg:'PHP错误信息泄露',tag:'OWASP_CRS/ERROR_DISCLOSURE/PHP'"

# 检测Java错误信息
SecRule RESPONSE_BODY "@rx (?i)(?:java|jsp|servlet|tomcat|jboss|weblogic|websphere)" "id:910430,phase:4,log,deny,status:403,msg:'Java错误信息泄露',tag:'OWASP_CRS/ERROR_DISCLOSURE/JAVA'"

# 检测ASP.NET错误信息
SecRule RESPONSE_BODY "@rx (?i)(?:asp|aspx|.net|microsoft|iis)" "id:910440,phase:4,log,deny,status:403,msg:'ASP.NET错误信息泄露',tag:'OWASP_CRS/ERROR_DISCLOSURE/ASP_NET'"