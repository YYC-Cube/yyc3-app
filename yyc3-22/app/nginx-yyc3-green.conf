# YYC3绿色环境Nginx配置

# 上游服务器配置 - 绿色环境
upstream api_green {
    server localhost:3100;
    keepalive 32;
}

upstream admin_green {
    server localhost:3101;
    keepalive 32;
}

upstream llm_green {
    server localhost:3102;
    keepalive 32;
}

upstream mail_green {
    server localhost:3105;
    keepalive 32;
}

upstream monitor_green {
    server localhost:3100;
    keepalive 32;
}

# HTTP到HTTPS重定向
server {
    listen 80;
    server_name api.0379.email admin.0379.email llm.0379.email mail.0379.email monitor.0379.email;
    
    return 301 https://$host$request_uri;
}

# API服务HTTPS配置
server {
    listen 443 ssl http2;
    server_name api.0379.email;
    
    # SSL证书配置（根据实际路径修改）
    ssl_certificate /etc/nginx/ssl/api.0379.email.crt;
    ssl_certificate_key /etc/nginx/ssl/api.0379.email.key;
    
    # SSL优化
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384;
    
    # 代理配置
    location / {
        proxy_pass http://api_green;
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
    }
    
    # 健康检查端点
    location /health {
        proxy_pass http://api_green/health;
    }
}

# Admin服务HTTPS配置
server {
    listen 443 ssl http2;
    server_name admin.0379.email;
    
    # SSL证书配置（根据实际路径修改）
    ssl_certificate /etc/nginx/ssl/admin.0379.email.crt;
    ssl_certificate_key /etc/nginx/ssl/admin.0379.email.key;
    
    # SSL优化
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384;
    
    # 代理配置
    location / {
        proxy_pass http://admin_green;
    }
    
    # 健康检查端点
    location /health {
        proxy_pass http://admin_green/health;
    }
}

# LLM服务HTTPS配置
server {
    listen 443 ssl http2;
    server_name llm.0379.email;
    
    # SSL证书配置（根据实际路径修改）
    ssl_certificate /etc/nginx/ssl/llm.0379.email.crt;
    ssl_certificate_key /etc/nginx/ssl/llm.0379.email.key;
    
    # SSL优化
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384;
    
    # 代理配置
    location / {
        proxy_pass http://llm_green;
    }
    
    # 健康检查端点
    location /health {
        proxy_pass http://llm_green/health;
    }
}

# Mail服务HTTPS配置
server {
    listen 443 ssl http2;
    server_name mail.0379.email;
    
    # SSL证书配置（根据实际路径修改）
    ssl_certificate /etc/nginx/ssl/mail.0379.email.crt;
    ssl_certificate_key /etc/nginx/ssl/mail.0379.email.key;
    
    # SSL优化
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384;
    
    # 代理配置
    location / {
        proxy_pass http://mail_green;
    }
    
    # 健康检查端点
    location /health {
        proxy_pass http://mail_green/health;
    }
}

# Monitor服务HTTPS配置
server {
    listen 443 ssl http2;
    server_name monitor.0379.email;
    
    # SSL证书配置（根据实际路径修改）
    ssl_certificate /etc/nginx/ssl/monitor.0379.email.crt;
    ssl_certificate_key /etc/nginx/ssl/monitor.0379.email.key;
    
    # SSL优化
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384;
    
    # 代理配置
    location / {
        proxy_pass http://monitor_green;
    }
    
    # 健康检查端点
    location /health {
        proxy_pass http://monitor_green/health;
    }
}
