# YYC3蓝色环境Nginx配置

# 上游服务器配置 - 蓝色环境
upstream api_blue {
    server localhost:6600;
    keepalive 32;
}

upstream admin_blue {
    server localhost:6601;
    keepalive 32;
}

upstream llm_blue {
    server localhost:6602;
    keepalive 32;
}

upstream mail_blue {
    server localhost:6603;
    keepalive 32;
}

upstream monitor_blue {
    server localhost:3002;
    keepalive 32;
}

# HTTP到HTTPS重定向
server {
    listen 80;
    server_name api.0379.email admin.0379.email llm.0379.email mail.0379.email monitor.0379.email;
    
    return 301 https://$host$request_uri;
}

# API服务HTTPS配置
server {
    listen 443 ssl http2;
    server_name api.0379.email;
    
    # SSL证书配置（根据实际路径修改）
    ssl_certificate /etc/nginx/ssl/api.0379.email.crt;
    ssl_certificate_key /etc/nginx/ssl/api.0379.email.key;
    
    # SSL优化
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384;
    
    # 代理配置
    location / {
        proxy_pass http://api_blue;
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
    }
    
    # 健康检查端点
    location /health {
        proxy_pass http://api_blue/health;
    }
}

# Admin服务HTTPS配置
server {
    listen 443 ssl http2;
    server_name admin.0379.email;
    
    # SSL证书配置（根据实际路径修改）
    ssl_certificate /etc/nginx/ssl/admin.0379.email.crt;
    ssl_certificate_key /etc/nginx/ssl/admin.0379.email.key;
    
    # SSL优化
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384;
    
    # 代理配置
    location / {
        proxy_pass http://admin_blue;
    }
    
    # 健康检查端点
    location /health {
        proxy_pass http://admin_blue/health;
    }
}

# LLM服务HTTPS配置
server {
    listen 443 ssl http2;
    server_name llm.0379.email;
    
    # SSL证书配置（根据实际路径修改）
    ssl_certificate /etc/nginx/ssl/llm.0379.email.crt;
    ssl_certificate_key /etc/nginx/ssl/llm.0379.email.key;
    
    # SSL优化
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384;
    
    # 代理配置
    location / {
        proxy_pass http://llm_blue;
    }
    
    # 健康检查端点
    location /health {
        proxy_pass http://llm_blue/health;
    }
}

# Mail服务HTTPS配置
server {
    listen 443 ssl http2;
    server_name mail.0379.email;
    
    # SSL证书配置（根据实际路径修改）
    ssl_certificate /etc/nginx/ssl/mail.0379.email.crt;
    ssl_certificate_key /etc/nginx/ssl/mail.0379.email.key;
    
    # SSL优化
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384;
    
    # 代理配置
    location / {
        proxy_pass http://mail_blue;
    }
    
    # 健康检查端点
    location /health {
        proxy_pass http://mail_blue/health;
    }
}

# Monitor服务HTTPS配置
server {
    listen 443 ssl http2;
    server_name monitor.0379.email;
    
    # SSL证书配置（根据实际路径修改）
    ssl_certificate /etc/nginx/ssl/monitor.0379.email.crt;
    ssl_certificate_key /etc/nginx/ssl/monitor.0379.email.key;
    
    # SSL优化
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384;
    
    # 代理配置
    location / {
        proxy_pass http://monitor_blue;
    }
    
    # 健康检查端点
    location /health {
        proxy_pass http://monitor_blue/health;
    }
}
