<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ç‰ˆæœ¬å˜æ›´è®°å½• - 0379.email</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* åŸºç¡€æ ·å¼ */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 20px;
      background-color: #f9f9f9;
      color: #333;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    /* æ ‡é¢˜æ ·å¼ */
    h1 {
      color: #2c3e50;
      margin-bottom: 30px;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
    }
    
    h2 {
      color: #34495e;
      margin-top: 40px;
    }
    
    /* ç‰ˆæœ¬é€‰æ‹©å™¨æ ·å¼ */
    .selector-container {
      margin: 20px 0;
    }
    
    label {
      font-weight: bold;
      margin-right: 10px;
      color: #2c3e50;
    }
    
    select {
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: white;
      font-size: 16px;
      width: 100%;
      max-width: 500px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: border-color 0.3s;
    }
    
    select:focus {
      outline: none;
      border-color: #3498db;
    }
    
    /* ç‰ˆæœ¬åŒºå—æ ·å¼ */
    .version-block {
      margin: 30px 0;
      padding: 20px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-left: 4px solid #3498db;
    }
    
    .version-title {
      font-weight: bold;
      font-size: 1.4em;
      color: #2c3e50;
      margin-bottom: 15px;
    }
    
    .change-section {
      margin-top: 15px;
    }
    
    .change-section h3 {
      color: #34495e;
      margin-bottom: 10px;
      font-size: 1.1em;
    }
    
    ul {
      padding-left: 25px;
    }
    
    li {
      margin-bottom: 8px;
    }
    
    /* å›¾è¡¨å®¹å™¨æ ·å¼ */
    .chart-container {
      margin: 30px 0;
      padding: 20px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    canvas {
      max-width: 100%;
      height: auto !important;
    }
    
    /* åŠ è½½çŠ¶æ€æ ·å¼ */
    .loading {
      text-align: center;
      padding: 40px;
      color: #7f8c8d;
    }
    
    /* é”™è¯¯æç¤ºæ ·å¼ */
    .error {
      padding: 20px;
      background-color: #ffdddd;
      border: 1px solid #ff9999;
      border-radius: 5px;
      color: #d32f2f;
      margin: 20px 0;
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      body {
        padding: 15px;
      }
      
      .version-block,
      .chart-container {
        padding: 15px;
      }
      
      select {
        width: 100%;
      }
    }
    
    /* æš—è‰²æ¨¡å¼æ”¯æŒ */
    @media (prefers-color-scheme: dark) {
      body {
        background-color: #1e1e1e;
        color: #eee;
      }
      
      h1 {
        color: #e0e0e0;
        border-bottom-color: #566473;
      }
      
      h2 {
        color: #d0d0d0;
      }
      
      label {
        color: #e0e0e0;
      }
      
      select {
        background-color: #2d2d2d;
        border-color: #444;
        color: #eee;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      }
      
      .version-block,
      .chart-container {
        background-color: #2d2d2d;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      }
      
      .version-title {
        color: #e0e0e0;
      }
      
      .change-section h3 {
        color: #d0d0d0;
      }
      
      .loading {
        color: #b0b0b0;
      }
      
      .error {
        background-color: #4a2525;
        border-color: #8b4513;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>ğŸ“˜ ç‰ˆæœ¬å˜æ›´è®°å½• - 0379.email</h1>
  
  <div class="selector-container">
    <label for="versionSelector">é€‰æ‹©ç‰ˆæœ¬ï¼š</label>
    <select id="versionSelector"></select>
  </div>
  
  <div id="changelogSummary">
    <div class="loading">åŠ è½½ä¸­...</div>
  </div>
  
  <div class="chart-container">
    <h2>ğŸ“Š ç‰ˆæœ¬å‘å¸ƒæ—¶é—´è¶‹åŠ¿</h2>
    <canvas id="versionTrend"></canvas>
  </div>
  
  <div class="chart-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <h2>ğŸ“Š æ¯ç‰ˆæœ¬å˜æ›´é¡¹æ•°é‡</h2>
      <div class="chart-controls">
        <button id="viewAllBtn" class="chart-btn active">å…¨éƒ¨</button>
        <button id="viewZhBtn" class="chart-btn">ä¸­æ–‡</button>
        <button id="viewEnBtn" class="chart-btn">è‹±æ–‡</button>
      </div>
    </div>
    <canvas id="changeStats"></canvas>
  </div>

  <script>
    // å…¨å±€æ•°æ®å˜é‡
    let changelogData = [];
    let versionsData = [];
    let versionTrendChart = null;
    let changeStatsChart = null;
    
    /**
     * åŠ è½½changelogå’Œversionsæ•°æ®
     */
    async function loadData() {
      try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        document.getElementById('changelogSummary').innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½ç‰ˆæœ¬æ•°æ®...</div>';
        
        // åŠ è½½changelog.json
        const changelogRes = await fetch('changelog.json');
        if (!changelogRes.ok) {
          throw new Error(`æ— æ³•åŠ è½½ changelog.json: ${changelogRes.status}`);
        }
        changelogData = await changelogRes.json();
        
        // åŠ è½½versions.json (å¦‚æœä¸å­˜åœ¨ï¼Œä»changelog.jsonç”Ÿæˆ)
        try {
          const versionsRes = await fetch('versions.json');
          if (versionsRes.ok) {
            versionsData = await versionsRes.json();
          } else {
            console.warn('versions.json ä¸å­˜åœ¨ï¼Œä» changelog.json ç”Ÿæˆ');
            versionsData = generateVersionsFromChangelog();
          }
        } catch (error) {
          console.warn('åŠ è½½ versions.json å¤±è´¥ï¼Œä» changelog.json ç”Ÿæˆ');
          versionsData = generateVersionsFromChangelog();
        }
        
        // åˆå§‹åŒ–é¡µé¢å…ƒç´ 
        populateVersionSelector();
        renderSummary();
        renderCharts();
        
      } catch (error) {
        console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
        document.getElementById('changelogSummary').innerHTML = `
          <div class="error">
            <strong>åŠ è½½å¤±è´¥:</strong> ${error.message}<br>
            è¯·æ£€æŸ¥ changelog.json æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®ã€‚
          </div>
        `;
      }
    }
    
    /**
     * ä»changelogæ•°æ®ç”Ÿæˆversionsæ•°æ®
     */
    function generateVersionsFromChangelog() {
      return changelogData.map(entry => ({
        version: entry.version,
        date: entry.date,
        timestamp: ''
      }));
    }
    
    /**
     * å¡«å……ç‰ˆæœ¬é€‰æ‹©å™¨
     */
    function populateVersionSelector() {
      const selector = document.getElementById('versionSelector');
      
      // æ¸…ç©ºç°æœ‰é€‰é¡¹
      selector.innerHTML = '';
      
      // æ·»åŠ é»˜è®¤é€‰é¡¹
      const defaultOption = document.createElement('option');
      defaultOption.value = 'all';
      defaultOption.textContent = 'æ˜¾ç¤ºæ‰€æœ‰ç‰ˆæœ¬';
      selector.appendChild(defaultOption);
      
      // æ·»åŠ å„ä¸ªç‰ˆæœ¬é€‰é¡¹
      versionsData.forEach(v => {
        const option = document.createElement('option');
        option.value = v.version;
        option.textContent = `${v.version} (${v.date})`;
        selector.appendChild(option);
      });
      
      // æ·»åŠ å˜æ›´äº‹ä»¶ç›‘å¬
      selector.addEventListener('change', renderSummary);
    }
    
    /**
     * æ¸²æŸ“é€‰ä¸­ç‰ˆæœ¬çš„å˜æ›´æ‘˜è¦
     */
    function renderSummary() {
      const selectedVersion = document.getElementById('versionSelector').value;
      const container = document.getElementById('changelogSummary');
      
      let entries = changelogData;
      if (selectedVersion && selectedVersion !== 'all') {
        entries = changelogData.filter(e => e.version === selectedVersion);
      }
      
      if (entries.length === 0) {
        container.innerHTML = '<div class="error">æœªæ‰¾åˆ°æŒ‡å®šç‰ˆæœ¬çš„å˜æ›´è®°å½•</div>';
        return;
      }
      
      // æ¸…ç©ºå®¹å™¨å¹¶æ·»åŠ ç‰ˆæœ¬å—
      container.innerHTML = '';
      
      entries.forEach(entry => {
        const block = document.createElement('div');
        block.className = 'version-block';
        
        // ç‰ˆæœ¬æ ‡é¢˜
        const title = document.createElement('div');
        title.className = 'version-title';
        title.textContent = `${entry.version} - ${entry.date}`;
        block.appendChild(title);
        
        // ä¸­æ–‡å˜æ›´é¡¹
        const zhSection = document.createElement('div');
        zhSection.className = 'change-section';
        const zhTitle = document.createElement('h3');
        zhTitle.textContent = 'ä¸­æ–‡å˜æ›´é¡¹';
        zhSection.appendChild(zhTitle);
        
        const zhList = document.createElement('ul');
        if (entry.changes && entry.changes.zh && Array.isArray(entry.changes.zh)) {
          entry.changes.zh.forEach(item => {
            const li = document.createElement('li');
            li.textContent = item;
            zhList.appendChild(li);
          });
        }
        zhSection.appendChild(zhList);
        block.appendChild(zhSection);
        
        // è‹±æ–‡å˜æ›´é¡¹
        const enSection = document.createElement('div');
        enSection.className = 'change-section';
        const enTitle = document.createElement('h3');
        enTitle.textContent = 'English Changes';
        enSection.appendChild(enTitle);
        
        const enList = document.createElement('ul');
        if (entry.changes && entry.changes.en && Array.isArray(entry.changes.en)) {
          entry.changes.en.forEach(item => {
            const li = document.createElement('li');
            li.textContent = item;
            enList.appendChild(li);
          });
        }
        enSection.appendChild(enList);
        block.appendChild(enSection);
        
        container.appendChild(block);
      });
    }
    
    /**
     * æ¸²æŸ“å›¾è¡¨
     */
    function renderCharts() {
      // é”€æ¯å·²å­˜åœ¨çš„å›¾è¡¨
      if (versionTrendChart) {
        versionTrendChart.destroy();
      }
      if (changeStatsChart) {
        changeStatsChart.destroy();
      }
      
      // è·å–ä¸Šä¸‹æ–‡
      const ctxTrend = document.getElementById('versionTrend').getContext('2d');
      const ctxStats = document.getElementById('changeStats').getContext('2d');
      
      // å‡†å¤‡æ•°æ®
      const labels = versionsData.map(v => v.version);
      const timestamps = versionsData.map(v => new Date(v.date).getTime());
      
      // è®¡ç®—å˜æ›´é¡¹æ•°é‡
      const enCounts = versionsData.map(v => {
        const entry = changelogData.find(e => e.version === v.version);
        return entry && entry.changes && entry.changes.en ? entry.changes.en.length : 0;
      });
      
      const zhCounts = versionsData.map(v => {
        const entry = changelogData.find(e => e.version === v.version);
        return entry && entry.changes && entry.changes.zh ? entry.changes.zh.length : 0;
      });
      
      // åˆ¤æ–­æš—è‰²æ¨¡å¼
      const isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const textColor = isDarkMode ? '#e0e0e0' : '#333';
      const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
      
      // åˆ›å»ºç‰ˆæœ¬è¶‹åŠ¿å›¾è¡¨
      versionTrendChart = new Chart(ctxTrend, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'å‘å¸ƒæ—¶é—´',
            data: timestamps,
            borderColor: '#3498db',
            backgroundColor: 'rgba(52, 152, 219, 0.2)',
            borderWidth: 2,
            pointBackgroundColor: '#3498db',
            pointRadius: 5,
            pointHoverRadius: 7,
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              labels: {
                color: textColor,
                font: {
                  size: 14
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `å‘å¸ƒæ—¶é—´: ${new Date(context.raw).toLocaleDateString('zh-CN')}`;
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                display: false
              },
              ticks: {
                color: textColor,
                font: {
                  size: 12
                }
              }
            },
            y: {
              grid: {
                color: gridColor
              },
              ticks: {
                color: textColor,
                font: {
                  size: 12
                },
                callback: function(value) {
                  return new Date(value).toLocaleDateString('zh-CN');
                }
              }
            }
          }
        }
      });
      
      // æ ¹æ®å½“å‰è§†å›¾å‡†å¤‡æ•°æ®é›†
      function getCurrentDatasets() {
        if (currentView === 'zh') {
          return [
            {
              label: 'ä¸­æ–‡å˜æ›´é¡¹',
              data: zhCounts,
              backgroundColor: 'rgba(46, 204, 113, 0.7)',
              borderColor: '#2ecc71',
              borderWidth: 1,
              hoverBackgroundColor: 'rgba(46, 204, 113, 0.9)',
              hoverBorderColor: '#2ecc71',
              pointHoverCursor: 'pointer'
            }
          ];
        } else if (currentView === 'en') {
          return [
            {
              label: 'è‹±æ–‡å˜æ›´é¡¹',
              data: enCounts,
              backgroundColor: 'rgba(243, 156, 18, 0.7)',
              borderColor: '#f39c12',
              borderWidth: 1,
              hoverBackgroundColor: 'rgba(243, 156, 18, 0.9)',
              hoverBorderColor: '#f39c12',
              pointHoverCursor: 'pointer'
            }
          ];
        } else { // 'all'
          return [
            {
              label: 'ä¸­æ–‡å˜æ›´é¡¹',
              data: zhCounts,
              backgroundColor: 'rgba(46, 204, 113, 0.7)',
              borderColor: '#2ecc71',
              borderWidth: 1,
              hoverBackgroundColor: 'rgba(46, 204, 113, 0.9)',
              hoverBorderColor: '#2ecc71',
              pointHoverCursor: 'pointer'
            },
            {
              label: 'è‹±æ–‡å˜æ›´é¡¹',
              data: enCounts,
              backgroundColor: 'rgba(243, 156, 18, 0.7)',
              borderColor: '#f39c12',
              borderWidth: 1,
              hoverBackgroundColor: 'rgba(243, 156, 18, 0.9)',
              hoverBorderColor: '#f39c12',
              pointHoverCursor: 'pointer'
            }
          ];
        }
      }
      
      // åˆ›å»ºå˜æ›´ç»Ÿè®¡å›¾è¡¨
      changeStatsChart = new Chart(ctxStats, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: getCurrentDatasets()
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                color: textColor,
                font: {
                  size: 14
                }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: '#2ecc71',
              borderWidth: 1,
              padding: 10,
              cornerRadius: 5,
              callbacks: {
                title: function(context) {
                  return `ç‰ˆæœ¬: ${context[0].label}`;
                },
                label: function(context) {
                  const version = context.label;
                  const entry = changelogData.find(e => e.version === version);
                  const zhCount = entry && entry.changes && entry.changes.zh ? entry.changes.zh.length : 0;
                  const enCount = entry && entry.changes && entry.changes.en ? entry.changes.en.length : 0;
                  
                  if (context.dataset.label.includes('ä¸­æ–‡')) {
                    return `ä¸­æ–‡å˜æ›´: ${zhCount}`;
                  } else if (context.dataset.label.includes('è‹±æ–‡')) {
                    return `è‹±æ–‡å˜æ›´: ${enCount}`;
                  }
                  return context.dataset.label + ': ' + context.raw;
                },
                afterBody: function(context) {
                  return ['(ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…)'];
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                display: false
              },
              ticks: {
                color: textColor,
                font: {
                  size: 12
                }
              }
            },
            y: {
              beginAtZero: true,
              grid: {
                color: gridColor
              },
              ticks: {
                color: textColor,
                font: {
                  size: 12
                },
                precision: 0
              }
            }
          },
          onClick: function(event, elements) {
            if (elements.length > 0) {
              const index = elements[0].index;
              const version = labels[index];
              selectVersion(version);
            }
          }
        }
      });
      
      // è®¾ç½®è§†å›¾åˆ‡æ¢æŒ‰é’®äº‹ä»¶
      setupViewToggleButtons();
    }
    
    /**
     * é€‰æ‹©æŒ‡å®šç‰ˆæœ¬
     */
    function selectVersion(version) {
      const selector = document.getElementById('versionSelector');
      selector.value = version;
      renderSummary();
      
      // æ»šåŠ¨åˆ°æ‘˜è¦éƒ¨åˆ†
      document.getElementById('changelogSummary').scrollIntoView({ behavior: 'smooth' });
    }
    
    /**
     * è®¾ç½®è§†å›¾åˆ‡æ¢æŒ‰é’®äº‹ä»¶
     */
    function setupViewToggleButtons() {
      const viewAllBtn = document.getElementById('viewAllBtn');
      const viewZhBtn = document.getElementById('viewZhBtn');
      const viewEnBtn = document.getElementById('viewEnBtn');
      
      if (viewAllBtn && viewZhBtn && viewEnBtn) {
        viewAllBtn.addEventListener('click', () => {
          currentView = 'all';
          updateViewButtons();
          updateChangeStatsChart();
        });
        
        viewZhBtn.addEventListener('click', () => {
          currentView = 'zh';
          updateViewButtons();
          updateChangeStatsChart();
        });
        
        viewEnBtn.addEventListener('click', () => {
          currentView = 'en';
          updateViewButtons();
          updateChangeStatsChart();
        });
      }
    }
    
    /**
     * æ›´æ–°è§†å›¾æŒ‰é’®çŠ¶æ€
     */
    function updateViewButtons() {
      const viewAllBtn = document.getElementById('viewAllBtn');
      const viewZhBtn = document.getElementById('viewZhBtn');
      const viewEnBtn = document.getElementById('viewEnBtn');
      
      if (viewAllBtn && viewZhBtn && viewEnBtn) {
        viewAllBtn.classList.toggle('active', currentView === 'all');
        viewZhBtn.classList.toggle('active', currentView === 'zh');
        viewEnBtn.classList.toggle('active', currentView === 'en');
      }
    }
    
    /**
     * æ›´æ–°å˜æ›´ç»Ÿè®¡å›¾è¡¨
     */
    function updateChangeStatsChart() {
      if (changeStatsChart) {
        changeStatsChart.data.datasets = getCurrentDatasets();
        changeStatsChart.update();
      }
    }
    
    /**
     * è·å–å½“å‰è§†å›¾çš„æ•°æ®é›†
     */
    function getCurrentDatasets() {
      const zhCounts = versionsData.map(v => {
        const entry = changelogData.find(e => e.version === v.version);
        return entry && entry.changes && entry.changes.zh ? entry.changes.zh.length : 0;
      });
      
      const enCounts = versionsData.map(v => {
        const entry = changelogData.find(e => e.version === v.version);
        return entry && entry.changes && entry.changes.en ? entry.changes.en.length : 0;
      });
      
      const labels = versionsData.map(v => v.version);
      
      if (currentView === 'zh') {
        return [
          {
            label: 'ä¸­æ–‡å˜æ›´é¡¹',
            data: zhCounts,
            backgroundColor: 'rgba(46, 204, 113, 0.7)',
            borderColor: '#2ecc71',
            borderWidth: 1,
            hoverBackgroundColor: 'rgba(46, 204, 113, 0.9)',
            hoverBorderColor: '#2ecc71'
          }
        ];
      } else if (currentView === 'en') {
        return [
          {
            label: 'è‹±æ–‡å˜æ›´é¡¹',
            data: enCounts,
            backgroundColor: 'rgba(243, 156, 18, 0.7)',
            borderColor: '#f39c12',
            borderWidth: 1,
            hoverBackgroundColor: 'rgba(243, 156, 18, 0.9)',
            hoverBorderColor: '#f39c12'
          }
        ];
      } else { // 'all'
        return [
          {
            label: 'ä¸­æ–‡å˜æ›´é¡¹',
            data: zhCounts,
            backgroundColor: 'rgba(46, 204, 113, 0.7)',
            borderColor: '#2ecc71',
            borderWidth: 1,
            hoverBackgroundColor: 'rgba(46, 204, 113, 0.9)',
            hoverBorderColor: '#2ecc71'
          },
          {
            label: 'è‹±æ–‡å˜æ›´é¡¹',
            data: enCounts,
            backgroundColor: 'rgba(243, 156, 18, 0.7)',
            borderColor: '#f39c12',
            borderWidth: 1,
            hoverBackgroundColor: 'rgba(243, 156, 18, 0.9)',
            hoverBorderColor: '#f39c12'
          }
        ];
      }
    }
    
    /**
     * ç›‘å¬æš—è‰²æ¨¡å¼å˜åŒ–
     */
    function setupDarkModeListener() {
      if (window.matchMedia) {
        const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
        mediaQuery.addEventListener('change', () => {
          // é‡æ–°æ¸²æŸ“å›¾è¡¨ä»¥é€‚åº”æ–°çš„é¢œè‰²æ¨¡å¼
          if (changelogData.length > 0) {
            renderCharts();
          }
        });
      }
    }
    
    /**
     * é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
     */
    document.addEventListener('DOMContentLoaded', () => {
      setupDarkModeListener();
      loadData();
    });
  </script>
</body>
</html>