# 服务访问问题解决方案总结

> ***YanYuCloudCube***
> **标语**：言启象限 | 语枢未来
> ***Words Initiate Quadrants, Language Serves as Core for the Future***
> **标语**：万象归元于云枢 | 深栈智启新纪元
> ***All things converge in the cloud pivot; Deep stacks ignite a new era of intelligence***

---

## 问题概述与诊断

在配置YYC3服务时遇到的核心问题是通过域名或ECS IP访问服务时出现404错误，而直接访问端口可以正常工作。经过诊断分析，确定问题出在以下几个方面：

1. **端口映射配置问题**：Docker Compose中服务端口映射配置不完整，部分服务无法通过外部端口访问
2. **服务监听地址限制**：部分服务（admin、llm）配置为仅监听127.0.0.1，导致无法从外部访问
3. **Nginx配置不匹配**：Nginx代理配置与实际服务端口和监听地址不匹配

## 已完成的配置调整

### 1. Docker Compose端口映射更新

已更新docker-compose.yml文件，配置了完整的端口映射：

- `api-server`: 6600:3000
- `admin-server`: 6601:3001
- `llm-server`: 6602:3002
- `mail-server`: 6603:3105
- `monitor-server`: 3002:3100

所有服务均配置了健康检查，确保服务正常运行：

```yaml
healthcheck:
  test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
  interval: 30s
  timeout: 10s
  retries: 3
```

### 2. 服务监听地址修改

已修改以下服务的监听地址，将其从127.0.0.1改为0.0.0.0，允许外部访问：

- `services/admin/server.js`
- `services/llm/server.js`

修改后的配置示例：

```javascript
const host = process.env.HOST || '0.0.0.0';
const port = process.env.PORT || 3001;
```

### 3. Nginx配置更新

已生成完整的Nginx配置文件，包括：

- 主配置文件：`nginx-main.conf`
- 蓝色环境配置：`nginx-yyc3-blue.conf`
- 绿色环境配置：`nginx-yyc3-green.conf`

主配置文件包含全局配置、安全头、SSL、日志、Gzip和代理设置，通过include指令引入环境配置文件。

蓝色环境配置定义了以下上游服务器：

- `api_blue`: 6600
- `admin_blue`: 6601
- `llm_blue`: 6602
- `mail_blue`: 6603
- `monitor_blue`: 3002

绿色环境配置定义了以下上游服务器：

- `api_green`: 3100
- `admin_green`: 3101
- `llm_green`: 3102
- `mail_green`: 3105
- `monitor_green`: 3100

## ECS当前状态分析

根据`阿里云ECS运行状态.md`文件内容，ECS当前配置如下：

### 1. 端口监听状态

- 80: Nginx HTTP服务
- 443: Nginx HTTPS服务
- 3100: node服务
- 18080: frps vhost HTTP端口
- 4443: frps vhost HTTPS端口
- 5001-5006: frps允许的端口范围
- 7001: frps绑定端口

### 2. Nginx配置

Nginx已在ECS上运行，配置文件路径：`/etc/nginx/nginx.conf`

- 主进程PID: 808
- 工作进程: 2个
- 配置包含`/etc/nginx/conf.d/*.conf`目录下的所有配置文件

### 3. frps配置

frps服务在ECS上运行，配置文件路径：`/root/frps/frps.toml`

- 绑定地址: 0.0.0.0
- 绑定端口: 7001
- 仪表板端口: 7500
- vhost HTTP端口: 18080
- vhost HTTPS端口: 4443
- 允许的端口范围: 5001,5002,5003,5004,5005,5006,6000

## 部署方案与操作流程

### 1. 部署前准备

**环境说明**：

- 所有操作在ECS上直接执行，与本地Mac设备无关
- ECS IP: 8.152.195.33
- ECS主机名: yyc3-33
- NAS IP: 192.168.3.45

### 2. 服务部署方案

#### 2.1 部署方式选择

**推荐方案**：直接将app根目录所有内容上传至ECS

- 优势：完整包含所有服务代码、配置文件和依赖
- 风险：需要确保文件权限和路径正确
- 操作：使用rsync或scp将整个app目录上传至ECS的指定位置

**备选方案**：仅上传相关服务项的文件

- 优势：传输量小，针对性强
- 风险：可能遗漏依赖文件或配置
- 操作：仅上传services目录下的相关服务代码

### 3. 详细操作流程

#### 3.1 文件上传至ECS

```bash
# 方案1：上传整个app目录（推荐）
scp -r -P 22 /path/to/local/app root@8.152.195.33:/opt/yyc3

# 方案2：仅上传services目录
scp -r -P 22 /path/to/local/app/services root@8.152.195.33:/opt/yyc3/services
```

#### 3.2 配置Nginx

1. **备份原有配置**：

```bash
ssh -p 22 root@8.152.195.33 "cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.bak"
```

2. **复制新配置**：

```bash
# 复制主配置文件
scp -P 22 /path/to/local/app/nginx-main.conf root@8.152.195.33:/etc/nginx/nginx.conf

# 复制环境配置文件
scp -P 22 /path/to/local/app/nginx-yyc3-blue.conf root@8.152.195.33:/etc/nginx/conf.d/
scp -P 22 /path/to/local/app/nginx-yyc3-green.conf root@8.152.195.33:/etc/nginx/conf.d/
```

3. **验证配置**：

```bash
ssh -p 22 root@8.152.195.33 "nginx -t"
```

4. **重启Nginx**：

```bash
ssh -p 22 root@8.152.195.33 "systemctl reload nginx"
```

#### 3.3 配置frps

1. **备份原有配置**：

```bash
ssh -p 22 root@8.152.195.33 "cp /root/frps/frps.toml /root/frps/frps.toml.bak"
```

2. **更新frps配置**：

```bash
# 仅当需要更新frps配置时执行
scp -P 22 /path/to/local/app/Frp/frps.toml root@8.152.195.33:/root/frps/
```

3. **重启frps**：

```bash
ssh -p 22 root@8.152.195.33 "systemctl restart frps"
```

#### 3.4 启动Docker服务

1. **进入app目录**：

```bash
ssh -p 22 root@8.152.195.33 "cd /opt/yyc3 && docker-compose up -d"
```

2. **验证服务状态**：

```bash
ssh -p 22 root@8.152.195.33 "cd /opt/yyc3 && docker-compose ps"
```

#### 3.5 NAS操作

1. **配置frpc**：确保NAS上的frpc配置与ECS上的frps配置匹配

```bash
# 连接到NAS
ssh -p 9557 yanyu@192.168.3.45

# 编辑frpc配置文件
vi /Volumes/www/frpc/frpc.toml

# 重启frpc服务
# 根据NAS上的服务管理方式执行
```

2. **验证连接**：检查frpc与frps的连接状态

```bash
ssh -p 9557 yanyu@192.168.3.45 "cat /Volumes/www/frpc/logs/frpc.log"
```

### 4. 服务验证

1. **检查Docker服务状态**：

```bash
ssh -p 22 root@8.152.195.33 "cd /opt/yyc3 && docker-compose logs -f"
```

2. **测试服务访问**：

- API服务: `https://api.0379.email`
- Admin服务: `https://admin.0379.email`
- LLM服务: `https://llm.0379.email`
- Mail服务: `https://mail.0379.email`
- Monitor服务: `https://monitor.0379.email`

3. **检查frp连接**：

```bash
ssh -p 22 root@8.152.195.33 "curl -f http://localhost:7500/api/proxy/tcp" -u yyc3:my151001
```

## 预防措施与优化建议

1. **配置版本控制**：将所有配置文件纳入版本控制，避免配置丢失
2. **自动化部署**：建立自动化部署流程，确保配置变更及时生效
3. **监控告警**：配置服务监控和告警，及时发现和解决服务访问问题
4. **安全加固**：定期更新SSL证书，配置安全头，加强服务安全
5. **文档更新**：及时更新相关文档，记录配置变更和解决步骤

## 问题解析

### 核心问题

服务访问404错误的主要原因是Nginx代理配置与实际服务端口和监听地址不匹配，导致请求无法正确转发到后端服务。

### 解决方案

1. **调整服务监听地址**：将服务从127.0.0.1改为0.0.0.0，允许外部访问
2. **配置Docker端口映射**：确保所有服务都有正确的端口映射
3. **更新Nginx配置**：确保Nginx代理配置与服务端口匹配
4. **同步配置到ECS**：将更新后的配置文件复制到ECS并重启服务

### 部署要点

1. **文件上传**：推荐上传整个app目录，确保所有依赖和配置文件完整
2. **配置备份**：在更新配置前，先备份原有配置文件
3. **服务验证**：部署完成后，验证所有服务是否可以正常访问
4. **frp连接**：确保NAS上的frpc与ECS上的frps连接正常

---

> 「***YanYuCloudCube***」
> 「***<admin@0379.email>***」
> 「***Words Initiate Quadrants, Language Serves as Core for the Future***」
> 「***All things converge in the cloud pivot; Deep stacks ignite a new era of intelligence***」
