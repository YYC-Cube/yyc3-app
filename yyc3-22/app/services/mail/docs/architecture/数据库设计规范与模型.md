# ğŸš€ ğŸ—„ï¸ YYCÂ³é‚®ä»¶å¹³å° - æ•°æ®åº“è®¾è®¡è§„èŒƒä¸æ¨¡å‹

> **YYCÂ³ é¡¹ç›®æ–‡æ¡£**
> 
> @project YYCÂ³ Email Platform
> @type æŠ€æœ¯æ–‡æ¡£
> @version 1.0.0
> @created 2025-12-08
> @updated 2025-12-08
> @author YYCÂ³ <admin@0379.email>
> @url https://github.com/YY-Nexus/0379-email-platform


## ğŸ“‹ è®¾è®¡æ¦‚è¿°

**æ•°æ®åº“ç±»å‹**: PostgreSQL 15.3+  
**è®¾è®¡åŸåˆ™**: é¢†åŸŸé©±åŠ¨è®¾è®¡ (DDD) + ç¬¬ä¸‰èŒƒå¼ (3NF)  
**ä¸€è‡´æ€§ç­–ç•¥**: ACIDäº‹åŠ¡ä¿è¯  
**æ‰©å±•ç­–ç•¥**: è¯»å†™åˆ†ç¦» + åˆ†åº“åˆ†è¡¨

### ğŸ¯ æ ¸å¿ƒè®¾è®¡ç†å¿µ

1. **é¢†åŸŸé©±åŠ¨**: æŒ‰ä¸šåŠ¡é¢†åŸŸåˆ’åˆ†æ•°æ®æ¨¡å‹
2. **æ€§èƒ½ä¼˜åŒ–**: åˆç†çš„ç´¢å¼•å’Œåˆ†åŒºç­–ç•¥
3. **æ•°æ®å®Œæ•´æ€§**: ä¸¥æ ¼çš„å¤–é”®çº¦æŸå’Œæ£€æŸ¥çº¦æŸ
4. **å®¡è®¡è¿½è¸ª**: å®Œæ•´çš„æ“ä½œæ—¥å¿—è®°å½•
5. **æ‰©å±•æ€§**: æ”¯æŒæ°´å¹³æ‰©å±•å’Œå‚ç›´æ‰©å±•

## ğŸ—ï¸ æ•°æ®åº“æ¶æ„

### é€»è¾‘æ¶æ„å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åº”ç”¨ç¨‹åºå±‚                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è¯»å†™åˆ†ç¦»å±‚ (Read/Write Splitting)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¸»åº“ (Write)    â”‚    ä»åº“ (Read x3)                       â”‚
â”‚  PostgreSQL-1    â”‚    PostgreSQL-2,3,4                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              æ•°æ®åˆ†ç‰‡å±‚ (Sharding)                          â”‚
â”‚  ç”¨æˆ·æ•°æ®    â”‚    é‚®ä»¶æ•°æ®    â”‚    åˆ†ææ•°æ®    â”‚    å®¡è®¡æ•°æ®  â”‚
â”‚  Shard-1     â”‚    Shard-2     â”‚    Shard-3     â”‚    Shard-4   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç‰©ç†éƒ¨ç½²æ¶æ„
```yaml
# docker-compose.yml æ•°æ®åº“é…ç½®
version: '3.8'

services:
  # ä¸»æ•°æ®åº“
  postgres-master:
    image: postgres:15.3-alpine
    environment:
      POSTGRES_DB: email_platform
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: secure_password
      POSTGRES_REPLICATION_MODE: master
      POSTGRES_REPLICATION_USER: replicator
      POSTGRES_REPLICATION_PASSWORD: replicator_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_master_data:/var/lib/postgresql/data
    command: |
      postgres
      -c wal_level=replica
      -c max_wal_senders=3
      -c wal_keep_segments=64
      -c max_connections=200

  # ä»æ•°æ®åº“
  postgres-slave-1:
    image: postgres:15.3-alpine
    environment:
      POSTGRES_DB: email_platform
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: secure_password
    ports:
      - "5433:5432"
    depends_on:
      - postgres-master
    command: |
      postgres
      -c wal_level=replica
      -c hot_standby=on
      -c max_connections=150

  # Redisé›†ç¾¤
  redis-cluster:
    image: redis:7.0-alpine
    command: redis-server --appendonly yes --requirepass redis_password
    ports:
      - "6379:6379"
      - "6380:6380"
    volumes:
      - redis_data:/data

volumes:
  postgres_master_data:
  redis_data:
```

## ğŸ“Š æ ¸å¿ƒæ•°æ®æ¨¡å‹

### 1. ç”¨æˆ·ç®¡ç†æ¨¡å—

#### users (ç”¨æˆ·è¡¨)
```sql
-- ç”¨æˆ·åŸºç¡€ä¿¡æ¯è¡¨
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    
    -- åŸºç¡€ä¿¡æ¯
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    phone VARCHAR(20),
    avatar_url TEXT,
    
    -- æƒé™æ§åˆ¶
    role user_role NOT NULL DEFAULT 'user',
    status user_status NOT NULL DEFAULT 'active',
    email_verified BOOLEAN DEFAULT false,
    two_factor_enabled BOOLEAN DEFAULT false,
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP WITH TIME ZONE,
    
    -- çº¦æŸ
    CONSTRAINT users_email_format CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'),
    CONSTRAINT users_username_format CHECK (username ~* '^[a-zA-Z0-9_-]{3,50}$')
);

-- ç”¨æˆ·è§’è‰²æšä¸¾
CREATE TYPE user_role AS ENUM ('admin', 'manager', 'user', 'guest');
CREATE TYPE user_status AS ENUM ('active', 'inactive', 'suspended', 'pending');

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_created_at ON users(created_at DESC);
```

#### user_profiles (ç”¨æˆ·é…ç½®è¡¨)
```sql
-- ç”¨æˆ·è¯¦ç»†é…ç½®è¡¨
CREATE TABLE user_profiles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    
    -- ä¸ªæ€§åŒ–è®¾ç½®
    timezone VARCHAR(50) DEFAULT 'UTC',
    language VARCHAR(10) DEFAULT 'zh-CN',
    date_format VARCHAR(20) DEFAULT 'YYYY-MM-DD',
    theme theme_type DEFAULT 'light',
    
    -- é‚®ä»¶è®¾ç½®
    email_signature TEXT,
    auto_reply_enabled BOOLEAN DEFAULT false,
    auto_reply_message TEXT,
    email_notifications BOOLEAN DEFAULT true,
    
    -- éšç§è®¾ç½®
    profile_visibility visibility_type DEFAULT 'private',
    allow_email_tracking BOOLEAN DEFAULT true,
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE TYPE theme_type AS ENUM ('light', 'dark', 'auto');
CREATE TYPE visibility_type AS ENUM ('public', 'private', 'friends');

CREATE UNIQUE INDEX idx_user_profiles_user_id ON user_profiles(user_id);
```

### 2. é‚®ä»¶æœåŠ¡æ¨¡å—

#### emails (é‚®ä»¶ä¸»è¡¨)
```sql
-- é‚®ä»¶ä¸»è¡¨
CREATE TABLE emails (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    sender_id UUID REFERENCES users(id),
    sender_email VARCHAR(255) NOT NULL,
    
    -- æ”¶ä»¶äººä¿¡æ¯
    recipients JSONB NOT NULL, -- æ”¯æŒå¤šä¸ªæ”¶ä»¶äºº
    -- æ ¼å¼: {"to": ["user1@example.com"], "cc": [], "bcc": []}
    
    -- é‚®ä»¶å†…å®¹
    subject VARCHAR(500) NOT NULL,
    body TEXT NOT NULL,
    body_html TEXT,
    is_html BOOLEAN DEFAULT false,
    charset VARCHAR(20) DEFAULT 'utf-8',
    
    -- é‚®ä»¶çŠ¶æ€
    status email_status NOT NULL DEFAULT 'pending',
    priority email_priority DEFAULT 'normal',
    category email_category DEFAULT 'general',
    
    -- å‘é€ä¿¡æ¯
    sent_at TIMESTAMP WITH TIME ZONE,
    delivered_at TIMESTAMP WITH TIME ZONE,
    read_at TIMESTAMP WITH TIME ZONE,
    
    -- æŠ€æœ¯ä¿¡æ¯
    message_id VARCHAR(255) UNIQUE,
    in_reply_to VARCHAR(255),
    references VARCHAR(255),
    
    -- é™„ä»¶ä¿¡æ¯
    has_attachments BOOLEAN DEFAULT false,
    attachment_count INTEGER DEFAULT 0,
    total_attachment_size BIGINT DEFAULT 0,
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT emails_subject_not_empty CHECK (length(trim(subject)) > 0),
    CONSTRAINT emails_recipients_not_empty CHECK (jsonb_array_length(recipients->'to') > 0)
);

-- æšä¸¾ç±»å‹
CREATE TYPE email_status AS ENUM (
    'pending', 'queued', 'sent', 'delivered', 
    'read', 'failed', 'bounced', 'complained', 'deleted'
);
CREATE TYPE email_priority AS ENUM ('low', 'normal', 'high', 'urgent');
CREATE TYPE email_category AS ENUM (
    'general', 'notification', 'marketing', 'transaction', 
    'system', 'spam', 'promotion', 'social'
);

-- ç´¢å¼•ç­–ç•¥
CREATE INDEX idx_emails_sender_created ON emails(sender_id, created_at DESC);
CREATE INDEX idx_emails_status_sent ON emails(status, sent_at DESC);
CREATE INDEX idx_emails_recipients ON emails USING GIN (recipients);
CREATE INDEX idx_emails_message_id ON emails(message_id);
CREATE INDEX idx_emails_category ON emails(category);
CREATE INDEX idx_emails_priority ON emails(priority);
CREATE INDEX idx_emails_has_attachments ON emails(has_attachments) WHERE has_attachments = true;
```

#### email_attachments (é‚®ä»¶é™„ä»¶è¡¨)
```sql
-- é‚®ä»¶é™„ä»¶è¡¨
CREATE TABLE email_attachments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email_id UUID REFERENCES emails(id) ON DELETE CASCADE,
    
    -- æ–‡ä»¶ä¿¡æ¯
    filename VARCHAR(255) NOT NULL,
    original_name VARCHAR(255) NOT NULL,
    mime_type VARCHAR(100) NOT NULL,
    file_size BIGINT NOT NULL,
    
    -- å­˜å‚¨ä¿¡æ¯
    storage_path TEXT NOT NULL,
    storage_provider storage_type DEFAULT 'local',
    storage_bucket VARCHAR(100),
    content_hash VARCHAR(64) NOT NULL, -- SHA-256
    
    -- çŠ¶æ€
    status attachment_status DEFAULT 'available',
    download_count INTEGER DEFAULT 0,
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT attachments_file_size_positive CHECK (file_size > 0),
    CONSTRAINT attachments_content_hash_format CHECK (length(content_hash) = 64)
);

CREATE TYPE storage_type AS ENUM ('local', 'aws_s3', 'aliyun_oss', 'qcloud_cos');
CREATE TYPE attachment_status AS ENUM ('available', 'deleted', 'corrupted');

-- ç´¢å¼•
CREATE INDEX idx_attachments_email_id ON email_attachments(email_id);
CREATE INDEX idx_attachments_hash ON email_attachments(content_hash);
CREATE INDEX idx_attachments_storage ON email_attachments(storage_provider, storage_path);
```

#### email_headers (é‚®ä»¶å¤´éƒ¨ä¿¡æ¯è¡¨)
```sql
-- é‚®ä»¶å¤´éƒ¨ä¿¡æ¯è¡¨
CREATE TABLE email_headers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email_id UUID REFERENCES emails(id) ON DELETE CASCADE,
    
    -- å¤´éƒ¨å­—æ®µ
    header_name VARCHAR(100) NOT NULL,
    header_value TEXT NOT NULL,
    header_order INTEGER NOT NULL DEFAULT 1,
    
    -- åˆ†ç±»å¤´éƒ¨
    header_category header_category_type DEFAULT 'custom',
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT headers_name_not_empty CHECK (length(trim(header_name)) > 0)
);

CREATE TYPE header_category_type AS ENUM (
    'standard', 'custom', 'received', 'dkim', 'spf', 'dmarc'
);

-- ç´¢å¼•
CREATE INDEX idx_headers_email_id ON email_headers(email_id);
CREATE INDEX idx_headers_name ON email_headers(header_name);
CREATE INDEX idx_headers_category ON email_headers(header_category);
```

### 3. AIæ™ºèƒ½åˆ†ææ¨¡å—

#### email_analysis (é‚®ä»¶åˆ†æè¡¨)
```sql
-- AIåˆ†æç»“æœè¡¨
CREATE TABLE email_analysis (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email_id UUID REFERENCES emails(id) ON DELETE CASCADE,
    
    -- AIåˆ†æç»“æœ
    classification ai_classification NOT NULL,
    confidence_score DECIMAL(5,4) NOT NULL CHECK (confidence_score BETWEEN 0 AND 1),
    
    -- å†…å®¹æå–
    key_information JSONB, -- å…³é”®ä¿¡æ¯æå–
    -- æ ¼å¼: {"dates": ["2024-01-01"], "people": [], "locations": [], "actions": []}
    
    -- æƒ…æ„Ÿåˆ†æ
    sentiment sentiment_type,
    sentiment_score DECIMAL(3,2) CHECK (sentiment_score BETWEEN -1 AND 1),
    
    -- åƒåœ¾é‚®ä»¶æ£€æµ‹
    spam_probability DECIMAL(3,2) DEFAULT 0 CHECK (spam_probability BETWEEN 0 AND 1),
    spam_factors JSONB, -- åƒåœ¾é‚®ä»¶åˆ¤æ–­å› å­
    
    -- æ™ºèƒ½å›å¤å»ºè®®
    reply_suggestions JSONB, -- å›å¤å»ºè®®
    -- æ ¼å¼: [{"text": "å»ºè®®å›å¤å†…å®¹", "tone": "formal", "confidence": 0.85}]
    
    -- å…ƒæ•°æ®
    model_version VARCHAR(50),
    processing_time_ms INTEGER,
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE TYPE ai_classification AS ENUM (
    'important', 'urgent', 'promotional', 'social', 'notification', 
    'spam', 'phishing', 'transactional', 'marketing'
);
CREATE TYPE sentiment_type AS ENUM ('positive', 'neutral', 'negative');

-- ç´¢å¼•
CREATE INDEX idx_analysis_email_id ON email_analysis(email_id);
CREATE INDEX idx_analysis_classification ON email_analysis(classification);
CREATE INDEX idx_analysis_sentiment ON email_analysis(sentiment);
CREATE INDEX idx_analysis_spam_prob ON email_analysis(spam_probability);
CREATE INDEX idx_analysis_confidence ON email_analysis(confidence_score DESC);
```

### 4. ç»Ÿè®¡åˆ†ææ¨¡å—

#### email_statistics (é‚®ä»¶ç»Ÿè®¡è¡¨)
```sql
-- é‚®ä»¶ç»Ÿè®¡è¡¨
CREATE TABLE email_statistics (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ç»Ÿè®¡ç»´åº¦
    stat_date DATE NOT NULL,
    user_id UUID REFERENCES users(id),
    
    -- åŸºç¡€æŒ‡æ ‡
    emails_sent INTEGER DEFAULT 0,
    emails_delivered INTEGER DEFAULT 0,
    emails_failed INTEGER DEFAULT 0,
    emails_read INTEGER DEFAULT 0,
    
    -- ç‡æŒ‡æ ‡
    delivery_rate DECIMAL(5,4) GENERATED ALWAYS AS (
        CASE WHEN emails_sent > 0 
             THEN emails_delivered::DECIMAL / emails_sent 
             ELSE 0 END
    ) STORED,
    
    open_rate DECIMAL(5,4) GENERATED ALWAYS AS (
        CASE WHEN emails_delivered > 0 
             THEN emails_read::DECIMAL / emails_delivered 
             ELSE 0 END
    ) STORED,
    
    -- åˆ†ç±»ç»Ÿè®¡
    category_stats JSONB, -- å„åˆ†ç±»é‚®ä»¶ç»Ÿè®¡
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT statistics_date_user_unique UNIQUE (stat_date, user_id)
);

-- ç´¢å¼•
CREATE INDEX idx_statistics_date ON email_statistics(stat_date DESC);
CREATE INDEX idx_statistics_user ON email_statistics(user_id);
CREATE INDEX idx_statistics_delivery_rate ON email_statistics(delivery_rate DESC);
```

### 5. ç³»ç»Ÿæ—¥å¿—æ¨¡å—

#### system_logs (ç³»ç»Ÿæ—¥å¿—è¡¨)
```sql
-- ç³»ç»Ÿæ“ä½œæ—¥å¿—è¡¨
CREATE TABLE system_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- æ—¥å¿—çº§åˆ«
    level log_level NOT NULL,
    
    -- ä¸Šä¸‹æ–‡ä¿¡æ¯
    service_name VARCHAR(100) NOT NULL,
    module_name VARCHAR(100),
    
    -- ç”¨æˆ·ä¿¡æ¯
    user_id UUID REFERENCES users(id),
    session_id VARCHAR(255),
    
    -- æ“ä½œä¿¡æ¯
    action VARCHAR(200) NOT NULL,
    resource_type VARCHAR(100),
    resource_id VARCHAR(255),
    
    -- æ—¥å¿—å†…å®¹
    message TEXT NOT NULL,
    details JSONB,
    error_stack TEXT,
    
    -- ç½‘ç»œä¿¡æ¯
    ip_address INET,
    user_agent TEXT,
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE TYPE log_level AS ENUM ('DEBUG', 'INFO', 'WARN', 'ERROR', 'FATAL');

-- ç´¢å¼•
CREATE INDEX idx_logs_level ON system_logs(level);
CREATE INDEX idx_logs_service ON system_logs(service_name);
CREATE INDEX idx_logs_user ON system_logs(user_id);
CREATE INDEX idx_logs_created_at ON system_logs(created_at DESC);
CREATE INDEX idx_logs_action ON system_logs(action);
```

## ğŸ”§ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. ç´¢å¼•ä¼˜åŒ–

#### å¤åˆç´¢å¼•è®¾è®¡
```sql
-- é‚®ä»¶æŸ¥è¯¢å¸¸ç”¨ç»„åˆç´¢å¼•
CREATE INDEX idx_emails_user_status_date ON emails(sender_id, status, created_at DESC);
CREATE INDEX idx_emails_recipient_status ON emails USING GIN ((recipients->'to'), status);
CREATE INDEX idx_emails_category_date ON emails(category, created_at DESC);

-- è¦†ç›–æŸ¥è¯¢ç´¢å¼•
CREATE INDEX idx_emails_sender_subject ON emails(sender_id, subject) INCLUDE (status, sent_at);
```

#### åˆ†åŒºè¡¨ç­–ç•¥
```sql
-- æŒ‰æ—¶é—´åˆ†åŒºé‚®ä»¶è¡¨
CREATE TABLE emails_partitioned (
    LIKE emails INCLUDING ALL
) PARTITION BY RANGE (created_at);

-- åˆ›å»ºæœˆåº¦åˆ†åŒº
CREATE TABLE emails_2024_01 PARTITION OF emails_partitioned
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

CREATE TABLE emails_2024_02 PARTITION OF emails_partitioned
    FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');
```

### 2. æŸ¥è¯¢ä¼˜åŒ–

#### åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–
```sql
-- æ¸¸æ ‡åˆ†é¡µä¼˜åŒ–
WITH ordered_emails AS (
    SELECT id, sender_id, subject, created_at,
           LAG(id) OVER (ORDER BY created_at DESC, id) as prev_id
    FROM emails 
    WHERE sender_id = $1
    ORDER BY created_at DESC, id DESC
    LIMIT $2
)
SELECT e.*, oe.prev_id
FROM emails e
JOIN ordered_emails oe ON e.id = oe.id;
```

#### ç»Ÿè®¡æŸ¥è¯¢ä¼˜åŒ–
```sql
-- ç‰©åŒ–è§†å›¾ç”¨äºç»Ÿè®¡
CREATE MATERIALIZED VIEW email_stats_daily AS
SELECT 
    DATE(created_at) as stat_date,
    COUNT(*) as total_emails,
    COUNT(*) FILTER (WHERE status = 'delivered') as delivered_count,
    COUNT(*) FILTER (WHERE status = 'read') as read_count
FROM emails 
GROUP BY DATE(created_at)
ORDER BY stat_date DESC;

-- å®šæœŸåˆ·æ–°ç‰©åŒ–è§†å›¾
CREATE OR REPLACE FUNCTION refresh_email_stats()
RETURNS void AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY email_stats_daily;
END;
$$ LANGUAGE plpgsql;
```

### 3. ç¼“å­˜ç­–ç•¥

#### Redisç¼“å­˜è®¾è®¡
```typescript
// ç¼“å­˜é”®è®¾è®¡
interface CacheKeys {
  user: {
    profile: (id: string) => `user:profile:${id}`;
    session: (id: string) => `user:session:${id}`;
    settings: (id: string) => `user:settings:${id}`;
  };
  email: {
    detail: (id: string) => `email:detail:${id}`;
    stats: (userId: string, period: string) => `email:stats:${userId}:${period}`;
    cache: (hash: string) => `email:cache:${hash}`;
  };
  analytics: {
    dashboard: (userId: string) => `analytics:dashboard:${userId}`;
    metrics: (query: string) => `analytics:metrics:${hash(query)}`;
  };
}

// ç¼“å­˜é…ç½®
const cacheConfig = {
  // TTLé…ç½®ï¼ˆç§’ï¼‰
  ttl: {
    userProfile: 3600,        // 1å°æ—¶
    emailDetail: 1800,        // 30åˆ†é’Ÿ
    emailStats: 900,          // 15åˆ†é’Ÿ
    analyticsData: 300,       // 5åˆ†é’Ÿ
    systemLogs: 60,           // 1åˆ†é’Ÿ
  },
  
  // ç¼“å­˜ç­–ç•¥
  strategy: {
    readThrough: ['userProfile', 'emailStats'],
    writeThrough: ['emailDetail'],
    cacheAside: ['analyticsData'],
  }
};
```

## ğŸ“Š æ•°æ®å®Œæ•´æ€§ä¿è¯

### 1. çº¦æŸç­–ç•¥

#### æ£€æŸ¥çº¦æŸ
```sql
-- é‚®ä»¶çŠ¶æ€æµè½¬çº¦æŸ
CREATE OR REPLACE FUNCTION validate_email_status_transition()
RETURNS TRIGGER AS $$
BEGIN
    -- åªå…è®¸å•å‘çŠ¶æ€æµè½¬
    IF NEW.status IS NOT NULL AND OLD.status IS NOT NULL THEN
        CASE OLD.status
            WHEN 'pending' THEN
                IF NEW.status NOT IN ('queued', 'sent', 'failed', 'deleted') THEN
                    RAISE EXCEPTION 'Invalid status transition from % to %', OLD.status, NEW.status;
                END IF;
            WHEN 'sent' THEN
                IF NEW.status NOT IN ('delivered', 'bounced', 'failed') THEN
                    RAISE EXCEPTION 'Invalid status transition from % to %', OLD.status, NEW.status;
                END IF;
            -- æ›´å¤šçŠ¶æ€æµè½¬è§„åˆ™...
        END CASE;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER email_status_transition_trigger
    BEFORE UPDATE ON emails
    FOR EACH ROW EXECUTE FUNCTION validate_email_status_transition();
```

#### å”¯ä¸€æ€§çº¦æŸ
```sql
-- ç”¨æˆ·é‚®ç®±å”¯ä¸€æ€§ï¼ˆè½¯åˆ é™¤è€ƒè™‘ï¼‰
CREATE UNIQUE INDEX idx_users_email_active 
ON users(email) 
WHERE deleted_at IS NULL;

-- æ¶ˆæ¯IDå…¨å±€å”¯ä¸€
CREATE UNIQUE INDEX idx_emails_message_id_unique 
ON emails(message_id) 
WHERE message_id IS NOT NULL;
```

### 2. æ•°æ®éªŒè¯

#### è§¦å‘å™¨éªŒè¯
```sql
-- é‚®ä»¶åœ°å€æ ¼å¼éªŒè¯
CREATE OR REPLACE FUNCTION validate_email_address()
RETURNS TRIGGER AS $$
DECLARE
    email_addr TEXT;
    addr_part TEXT;
    domain_part TEXT;
BEGIN
    -- éªŒè¯æ”¶ä»¶äººé‚®ç®±æ ¼å¼
    FOR email_addr IN SELECT jsonb_array_elements_text(NEW.recipients->'to')
    LOOP
        IF email_addr !~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$' THEN
            RAISE EXCEPTION 'Invalid email address format: %', email_addr;
        END IF;
    END LOOP;
    
    -- éªŒè¯å‘ä»¶äººé‚®ç®±
    IF NEW.sender_email !~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$' THEN
        RAISE EXCEPTION 'Invalid sender email format: %', NEW.sender_email;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER validate_email_trigger
    BEFORE INSERT OR UPDATE ON emails
    FOR EACH ROW EXECUTE FUNCTION validate_email_address();
```

## ğŸ”„ æ•°æ®è¿ç§»ç­–ç•¥

### 1. ç‰ˆæœ¬æ§åˆ¶

#### è¿ç§»æ–‡ä»¶ç»“æ„
```
database/
â”œâ”€â”€ migrations/
â”‚   â”œâ”€â”€ 2024_01_15_0001_create_users_table.sql
â”‚   â”œâ”€â”€ 2024_01_15_0002_create_emails_table.sql
â”‚   â”œâ”€â”€ 2024_01_16_0003_add_email_analysis.sql
â”‚   â””â”€â”€ 2024_01_17_0004_create_statistics_views.sql
â”œâ”€â”€ seeds/
â”‚   â”œâ”€â”€ 001_admin_user.sql
â”‚   â””â”€â”€ 002_system_config.sql
â””â”€â”€ schemas/
    â”œâ”€â”€ users.sql
    â”œâ”€â”€ emails.sql
    â””â”€â”€ analytics.sql
```

#### è¿ç§»ç¤ºä¾‹
```sql
-- 2024_01_15_0001_create_users_table.sql
BEGIN;

-- åˆ›å»ºç”¨æˆ·è¡¨
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role user_role NOT NULL DEFAULT 'user',
    status user_status NOT NULL DEFAULT 'active',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_status ON users(status);

-- æ’å…¥åˆå§‹æ•°æ®
INSERT INTO users (username, email, password_hash, role, status) VALUES
('admin', 'admin@0379.email', '$2b$10$...', 'admin', 'active');

COMMIT;
```

### 2. æ•°æ®å¤‡ä»½ç­–ç•¥

#### å¤‡ä»½è„šæœ¬
```bash
#!/bin/bash
# backup_database.sh

set -euo pipefail

# é…ç½®
DB_NAME="email_platform"
BACKUP_DIR="/backups/$(date +%Y-%m-%d)"
S3_BUCKET="0379-email-backups"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p "$BACKUP_DIR"

# æ•°æ®åº“å®Œæ•´å¤‡ä»½
pg_dump -h localhost -U admin -d "$DB_NAME" \
    --verbose --clean --no-owner --no-privileges \
    --format=custom --compress=6 \
    --file="$BACKUP_DIR/full_backup.dump"

# Schemaå¤‡ä»½
pg_dump -h localhost -U admin -d "$DB_NAME" \
    --schema-only --verbose --no-owner --no-privileges \
    --format=plain --file="$BACKUP_DIR/schema.sql"

# æ•°æ®å¤‡ä»½ï¼ˆä»…æ•°æ®ï¼‰
pg_dump -h localhost -U admin -d "$DB_NAME" \
    --data-only --verbose --no-owner --no-privileges \
    --format=custom --compress=6 \
    --file="$BACKUP_DIR/data_only.dump"

# å‹ç¼©å¤‡ä»½
tar -czf "$BACKUP_DIR/backup.tar.gz" -C "$BACKUP_DIR" *.dump *.sql

# ä¸Šä¼ åˆ°S3
aws s3 cp "$BACKUP_DIR/backup.tar.gz" "s3://$S3_BUCKET/backups/"

# æ¸…ç†æœ¬åœ°æ–‡ä»¶
rm -rf "$BACKUP_DIR"

echo "Database backup completed successfully"
```

---

## ğŸ“‹ æ€»ç»“

æ•°æ®åº“è®¾è®¡æ˜¯ç³»ç»Ÿç¨³å®šè¿è¡Œçš„åŸºç¡€ã€‚é€šè¿‡åˆç†çš„æ•°æ®æ¨¡å‹è®¾è®¡ã€å®Œå–„çš„ç´¢å¼•ç­–ç•¥å’Œä¸¥æ ¼çš„æ•°æ®å®Œæ•´æ€§ä¿è¯ï¼Œç¡®ä¿ç³»ç»Ÿèƒ½å¤Ÿé«˜æ•ˆå¤„ç†å¤§é‡é‚®ä»¶æ•°æ®ã€‚

**è®¾è®¡ä¼˜åŠ¿**:
- âœ… é¢†åŸŸé©±åŠ¨çš„æ¨¡å—åŒ–è®¾è®¡
- âœ… å®Œå–„çš„çº¦æŸå’ŒéªŒè¯æœºåˆ¶
- âœ… é«˜æ€§èƒ½çš„æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥
- âœ… å¯é çš„æ•°æ®å¤‡ä»½å’Œæ¢å¤æ–¹æ¡ˆ

**æŒç»­ä¼˜åŒ–**:
- ğŸ”„ å®šæœŸæ€§èƒ½åˆ†æå’Œä¼˜åŒ–
- ğŸ”„ ç›‘æ§æ…¢æŸ¥è¯¢å’Œç´¢å¼•ä½¿ç”¨ç‡
- ğŸ”„ æ ¹æ®ä¸šåŠ¡å¢é•¿è°ƒæ•´åˆ†åŒºç­–ç•¥
- ğŸ”„ ä¼˜åŒ–ç¼“å­˜å‘½ä¸­ç‡

ä¿æŒä»£ç å¥åº·ï¼Œç¨³æ­¥å‰è¡Œï¼ ğŸŒ¹