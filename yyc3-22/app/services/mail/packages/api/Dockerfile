# ğŸš€ é‚®ä»¶å¹³å°APIæœåŠ¡Dockerfile
# @file Dockerfile
# @description APIæœåŠ¡çš„Dockerå®¹å™¨æ„å»ºé…ç½®
# @author YYC
# @version 1.0.0
# @created 2024-10-15

# ===== æ„å»ºé˜¶æ®µ =====
FROM node:20-alpine AS builder

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶package.jsonå’Œpackage-lock.json
COPY package*.json ./

# å®‰è£…ä¾èµ–
RUN npm ci

# å¤åˆ¶æºä»£ç 
COPY src/ ./src/
COPY tsconfig.json ./

# æ„å»ºé¡¹ç›®
RUN npm run build

# ===== è¿è¡Œé˜¶æ®µ =====
FROM node:20-alpine

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# åˆ›å»ºérootç”¨æˆ·
RUN addgroup -g 1001 -S nodejs && adduser -S appuser -u 1001 -G nodejs

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/package*.json ./

# å®‰è£…ç”Ÿäº§ä¾èµ–
RUN npm ci --only=production

# å¤åˆ¶ç¯å¢ƒå˜é‡ç¤ºä¾‹æ–‡ä»¶
COPY .env.example ./

# è®¾ç½®æ–‡ä»¶æƒé™
RUN chown -R appuser:nodejs /app

# åˆ‡æ¢åˆ°érootç”¨æˆ·
USER appuser

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV PORT=3000

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¯åŠ¨å‘½ä»¤
CMD ["npm", "start"]

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:3000/health || exit 1