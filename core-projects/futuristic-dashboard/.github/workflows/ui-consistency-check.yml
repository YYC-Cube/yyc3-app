name: UI Consistency Check

on:
  # å½“PRæäº¤æˆ–æ›´æ–°åˆ°mainæˆ–developåˆ†æ”¯æ—¶è¿è¡Œ
  pull_request:
    branches: [main, develop]
    paths:
      - 'components/**/*.{jsx,tsx,css,scss}'
      - 'app/**/*.{jsx,tsx,css,scss}'
      - 'pages/**/*.{jsx,tsx,css,scss}'
      - 'lib/theme/**/*.{js,ts,css,scss}'
      - 'styles/**/*.{css,scss}'
  # å½“ä»£ç æ¨é€åˆ°mainåˆ†æ”¯æ—¶è¿è¡Œ
  push:
    branches: [main]
    paths:
      - 'components/**/*.{jsx,tsx,css,scss}'
      - 'app/**/*.{jsx,tsx,css,scss}'
      - 'pages/**/*.{jsx,tsx,css,scss}'
      - 'lib/theme/**/*.{js,ts,css,scss}'
      - 'styles/**/*.{css,scss}'
  # å®šæ—¶è¿è¡Œï¼ˆæ¯å¤©UTCæ—¶é—´02:00ï¼‰
  schedule:
    - cron: '0 2 * * *'
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      check_depth:
        description: 'æ£€æŸ¥æ·±åº¦'
        required: true
        default: 'basic'
        type: choice
        options:
          - basic
          - detailed
          - full

jobs:
  # è¿è¡ŒUIä¸€è‡´æ€§æ£€æŸ¥
  ui-consistency-check:
    name: UI Consistency Check
    runs-on: ubuntu-latest
    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ä»¥ä¾¿æ¯”è¾ƒ

      # è®¾ç½®Node.jsç¯å¢ƒ
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'

      # å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: pnpm install
        env:
          CI: true

      # è¿è¡ŒUIä¸€è‡´æ€§æ£€æŸ¥è„šæœ¬
      - name: Run UI consistency check
        run: pnpm run ui-check
        env:
          # è®¾ç½®CIç¯å¢ƒå˜é‡
          CI: true
          # è®¾ç½®æ£€æŸ¥æ·±åº¦
          UI_CHECK_DEPTH: ${{ github.event.inputs.check_depth || 'basic' }}
          # æä¾›GitHub Tokenç”¨äºåˆ›å»º/æ›´æ–°é—®é¢˜
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # å…¶ä»–ç¯å¢ƒå˜é‡
          NODE_ENV: test

      # ç”ŸæˆUIä¸€è‡´æ€§æŠ¥å‘Š
      - name: Generate UI consistency report
        run: pnpm run ui-generate-report
        if: success() || failure()
        env:
          CI: true
          REPORT_FORMAT: 'markdown,json'

      # ä¿å­˜æŠ¥å‘Šä½œä¸ºæ„å»ºäº§ç‰©
      - name: Upload UI consistency report
        uses: actions/upload-artifact@v3
        with:
          name: ui-consistency-report
          path: reports/ui-consistency/
          retention-days: 14

      # å¦‚æœæ˜¯PRï¼Œå°†æŠ¥å‘Šä½œä¸ºè¯„è®ºæ·»åŠ åˆ°PR
      - name: Comment on PR with report
        if: github.event_name == 'pull_request' && (success() || failure())
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // è¯»å–æŠ¥å‘Šæ–‡ä»¶
            let reportContent = '';
            try {
              reportContent = fs.readFileSync(
                path.join(process.env.GITHUB_WORKSPACE, 'reports/ui-consistency/summary.md'),
                'utf8'
              );
            } catch (error) {
              console.error('æ— æ³•è¯»å–æŠ¥å‘Šæ–‡ä»¶:', error);
              reportContent = 'æ— æ³•ç”ŸæˆUIä¸€è‡´æ€§æŠ¥å‘Šï¼Œè¯·æŸ¥çœ‹å·¥ä½œæµæ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯ã€‚';
            }
            
            // æ„å»ºè¯„è®ºå†…å®¹
            const commentBody = `## ğŸ“Š UIä¸€è‡´æ€§æ£€æŸ¥æŠ¥å‘Š\n\n${reportContent}\n\n**æ³¨æ„**: æ­¤æŠ¥å‘Šç”±è‡ªåŠ¨åŒ–å·¥å…·ç”Ÿæˆã€‚è¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šäº†è§£æ›´å¤šä¿¡æ¯ã€‚`;
            
            // åˆ›å»ºæˆ–æ›´æ–°PRè¯„è®º
            try {
              // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯„è®º
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
              
              const existingComment = comments.find(comment => 
                comment.user.login === 'github-actions[bot]' && 
                comment.body.startsWith('## ğŸ“Š UIä¸€è‡´æ€§æ£€æŸ¥æŠ¥å‘Š')
              );
              
              if (existingComment) {
                // æ›´æ–°ç°æœ‰è¯„è®º
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existingComment.id,
                  body: commentBody,
                });
              } else {
                // åˆ›å»ºæ–°è¯„è®º
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: commentBody,
                });
              }
            } catch (error) {
              console.error('æ— æ³•æ·»åŠ è¯„è®º:', error);
            }

      # åˆ›å»ºGitHubé—®é¢˜ï¼ˆå¦‚æœå‘ç°é—®é¢˜ï¼‰
      - name: Create GitHub issues for UI problems
        if: failure() && env.UI_CREATE_ISSUES == 'true'
        run: pnpm run ui-create-issues
        env:
          CI: true
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # æ§åˆ¶æ˜¯å¦åˆ›å»ºé—®é¢˜
          UI_CREATE_ISSUES: 'true'
          # ä»…ä¸ºé«˜ä¸¥é‡æ€§é—®é¢˜åˆ›å»ºé—®é¢˜
          UI_ISSUE_SEVERITY_LEVEL: 'high,medium'

  # è¿è¡ŒUIè§†è§‰å›å½’æµ‹è¯•
  ui-visual-regression:
    name: UI Visual Regression Test
    needs: ui-consistency-check
    runs-on: ubuntu-latest
    # åªæœ‰åœ¨PRä¸Šæ‰è¿è¡Œå®Œæ•´çš„è§†è§‰å›å½’æµ‹è¯•
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'

      - name: Install dependencies
        run: pnpm install
        env:
          CI: true

      # æ„å»ºStorybook
      - name: Build Storybook
        run: pnpm run storybook:build

      # è¿è¡ŒChromaticè§†è§‰å›å½’æµ‹è¯•
      - name: Run Chromatic visual regression tests
        uses: chromaui/action@v1
        with:
          # Chromaticé¡¹ç›®ä»¤ç‰Œï¼ˆåœ¨Chromatic.ioä¸Šåˆ›å»ºé¡¹ç›®è·å–ï¼‰
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
          # æ„å»ºè„šæœ¬
          buildScriptName: 'storybook:build'
          # æ„å»ºæ•…äº‹ä¹¦çš„è¾“å‡ºç›®å½•
          storybookBuildDir: './storybook-static'
          # å…è®¸æ§åˆ¶å°é”™è¯¯ï¼ˆæ ¹æ®éœ€è¦è°ƒæ•´ï¼‰
          allowConsoleErrors: false
          # ä»…åœ¨PRä¸Šè‡ªåŠ¨æ¥å—æ›´æ”¹
          autoAcceptChanges: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false }}
          # æ§åˆ¶æ˜¯å¦å‘å¸ƒæ„å»º
          exitZeroOnChanges: true
          # ä»…ä¸ºPRè¿è¡Œå¢é‡æµ‹è¯•
          onlyChanged: true

  # ç”ŸæˆUIä¸€è‡´æ€§è¶‹åŠ¿æŠ¥å‘Š
  ui-consistency-trend:
    name: UI Consistency Trend Report
    needs: ui-consistency-check
    runs-on: ubuntu-latest
    # åªæœ‰åœ¨ä¸»åˆ†æ”¯ä¸Šæˆ–æ‰‹åŠ¨è§¦å‘æ—¶æ‰ç”Ÿæˆè¶‹åŠ¿æŠ¥å‘Š
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # ç¡®ä¿æˆ‘ä»¬å¯ä»¥æ¨åŠ¨æ›´æ”¹
          persist-credentials: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'

      - name: Install dependencies
        run: pnpm install
        env:
          CI: true

      # ä¸‹è½½ä¹‹å‰ä¸Šä¼ çš„æŠ¥å‘Š
      - name: Download UI consistency report
        uses: actions/download-artifact@v3
        with:
          name: ui-consistency-report
          path: reports/ui-consistency/

      # ç”Ÿæˆè¶‹åŠ¿æŠ¥å‘Š
      - name: Generate trend report
        run: pnpm run ui-generate-trend
        env:
          CI: true

      # æäº¤è¶‹åŠ¿æ•°æ®
      - name: Commit trend data
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add reports/ui-consistency/trend.json
          git commit -m "chore(ui-consistency): æ›´æ–°UIä¸€è‡´æ€§è¶‹åŠ¿æ•°æ®" || echo "æ²¡æœ‰æ›´æ”¹å¯æäº¤"
          git push origin main
        # åªæœ‰åœ¨ä¸»åˆ†æ”¯ä¸Šæ‰æ¨é€æ›´æ”¹
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œåˆ™å‘é€è¶‹åŠ¿æŠ¥å‘Šé€šçŸ¥
      - name: Send trend report notification
        if: github.event_name == 'workflow_dispatch'
        run: pnpm run ui-send-trend-notification
        env:
          CI: true
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          # å¯é€‰ï¼šTeams webhook URL
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}