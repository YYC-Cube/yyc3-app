# =============================================================================
# 0379.email 统一配置管理中心
# 提供服务发现、配置管理、密钥管理和API网关功能
# =============================================================================

version: '3.8'

networks:
  config-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16
          gateway: 172.21.0.1

volumes:
  consul_data:
    driver: local
  vault_data:
    driver: local
  prometheus_config_data:
    driver: local
  grafana_config_data:
    driver: local

services:
  # =============================================================================
  # Consul 服务发现和配置管理
  # =============================================================================
  consul:
    image: consul:1.17
    container_name: 0379-consul
    restart: unless-stopped
    ports:
      - "8500:8500"    # Web UI
      - "8600:8600/udp" # DNS
    networks:
      - config-network
    volumes:
      - consul_data:/consul/data
      - ./consul/config:/consul/config
      - ./consul/scripts:/consul/scripts
    environment:
      - CONSUL_BIND_INTERFACE=eth0
      - CONSUL_CLIENT_INTERFACE=eth0
      - CONSUL_ADVERTISE_ADDR=172.21.0.10
      - CONSUL_RETRY_JOIN=172.21.0.10
      - CONSUL_BOOTSTRAP_EXPECT=1
      - CONSUL_DATA_DIR=/consul/data
      - CONSUL_CONFIG_DIR=/consul/config
      - CONSUL_DOMAIN=0379.email
    command: >
      consul agent
      -server
      -bootstrap-expect=1
      -ui
      -bind=0.0.0.0
      -client=0.0.0.0
      -datacenter=0379-dc1
      -data-dir=/consul/data
      -config-dir=/consul/config
    healthcheck:
      test: ["CMD", "consul", "members"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # =============================================================================
  # Vault 密钥管理
  # =============================================================================
  vault:
    image: vault:1.15
    container_name: 0379-vault
    restart: unless-stopped
    ports:
      - "8200:8200"
    networks:
      - config-network
    volumes:
      - vault_data:/vault/data
      - ./vault/config:/vault/config
      - ./vault/policies:/vault/policies
    environment:
      - VAULT_ADDR=http://0.0.0.0:8200
      - VAULT_API_ADDR=http://172.21.0.11:8200
      - VAULT_CLUSTER_ADDR=http://172.21.0.11:8201
      - VAULT_DEV_ROOT_TOKEN_ID=vs-0379-email-root
      - VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200
    command: server -dev -dev-root-token-id=vs-0379-email-root -dev-listen-address=0.0.0.0:8200
    cap_add:
      - IPC_LOCK
    depends_on:
      - consul
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # =============================================================================
  # Kong API网关
  # =============================================================================
  kong:
    image: kong:3.4
    container_name: 0379-kong
    restart: unless-stopped
    ports:
      - "8000:8000"    # HTTP API Gateway
      - "8443:8443"    # HTTPS API Gateway
      - "8001:8001"    # Admin API
      - "8444:8444"    # Admin API SSL
      - "8002:8002"    # Proxy Server
      - "8445:8445"    # Proxy Server SSL
      - "8003:8003"    # Manager
      - "8004:8004"    # Portal
    networks:
      - config-network
    volumes:
      - ./kong/config:/kong/config
      - ./kong/kong.yml:/kong.yml:ro
    environment:
      - KONG_DATABASE=off
      - KONG_DECLARATIVE_CONFIG=/kong.yml
      - KONG_PROXY_ACCESS_LOG=/dev/stdout
      - KONG_ADMIN_ACCESS_LOG=/dev/stdout
      - KONG_PROXY_ERROR_LOG=/dev/stderr
      - KONG_ADMIN_ERROR_LOG=/dev/stderr
      - KONG_ADMIN_LISTEN=0.0.0.0:8001
      - KONG_ADMIN_GUI_URL=http://localhost:8002
      - KONG_ADMIN_GUI_PATH=/manager
    command: kong start --conf /kong.yml
    depends_on:
      - consul
      - vault
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # =============================================================================
  # Kong Manager (可选的管理界面)
  # =============================================================================
  kong-manager:
    image: pantsel/konga
    container_name: 0379-kong-manager
    restart: unless-stopped
    ports:
      - "1337:1337"
    networks:
      - config-network
    environment:
      - NODE_ENV=development
      - KONGA_HOOK_TIMEOUT=10000
    depends_on:
      - kong

  # =============================================================================
  # 配置同步服务
  # =============================================================================
  config-sync:
    image: alpine:latest
    container_name: 0379-config-sync
    restart: unless-stopped
    networks:
      - config-network
    volumes:
      - ./scripts:/scripts
      - ../:/source:ro
    environment:
      - CONSUL_ADDR=consul:8500
      - VAULT_ADDR=vault:8200
      - VAULT_TOKEN=vs-0379-email-root
    command: >
      sh -c "
        apk add --no-cache curl jq &&
        while true; do
          echo '[$(date)] Syncing configuration...' &&
          /scripts/sync-config.sh &&
          sleep 300
        done
      "
    depends_on:
      - consul
      - vault

  # =============================================================================
  # 配置中心监控
  # =============================================================================
  config-prometheus:
    image: prom/prometheus:latest
    container_name: 0379-config-prometheus
    restart: unless-stopped
    ports:
      - "9091:9090"
    networks:
      - config-network
    volumes:
      - prometheus_config_data:/prometheus
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/targets:/etc/prometheus/targets:ro
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=7d'
      - '--web.enable-lifecycle'
    depends_on:
      - consul
      - vault
      - kong

  config-grafana:
    image: grafana/grafana:latest
    container_name: 0379-config-grafana
    restart: unless-stopped
    ports:
      - "3006:3000"
    networks:
      - config-network
    volumes:
      - grafana_config_data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=config-admin-0379
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_INSTALL_PLUGINS=consul-datasource,vault-datasource
      - GF_SERVER_DOMAIN=localhost
      - GF_SERVER_ROOT_URL=http://localhost:3006
    depends_on:
      - config-prometheus

  # =============================================================================
  # 健康检查服务
  # =============================================================================
  health-check:
    image: alpine:latest
    container_name: 0379-health-check
    restart: unless-stopped
    networks:
      - config-network
    environment:
      - CONSUL_ADDR=consul:8500
      - VAULT_ADDR=vault:8200
      - KONG_ADDR=kong:8001
    command: >
      sh -c "
        apk add --no-cache curl jq &&
        while true; do
          echo '=== Health Check Report ===' &&
          echo '[$(date)] Consul: $$(curl -s http://consul:8500/v1/status/leader | jq -r .)' &&
          echo '[$(date)] Vault: $$(curl -s http://vault:8200/v1/sys/health -H \"X-Vault-Token: vs-0379-email-root\" | jq -r .initialized)' &&
          echo '[$(date)] Kong: $$(curl -s http://kong:8001/ | jq -r .tagline)' &&
          echo '=========================' &&
          sleep 60
        done
      "
    depends_on:
      - consul
      - vault
      - kong