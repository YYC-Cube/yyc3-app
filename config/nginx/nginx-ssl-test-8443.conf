# =============================================================================
# 0379.email 项目 - Nginx SSL 测试配置
# =============================================================================

worker_processes 1;
error_log /Users/yanyu/www/logs/nginx/error.log warn;
pid /Users/yanyu/www/logs/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /opt/homebrew/etc/nginx/mime.types;
    default_type application/octet-stream;

    # 日志格式
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /Users/yanyu/www/logs/nginx/access.log main;

    # 基础设置
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    server_tokens off;

    # SSL 配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # 安全头配置
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # =============================================================================
    # 主站点 HTTPS
    # =============================================================================

    # HTTP 重定向到 HTTPS
    server {
        listen 80;
        server_name 0379.email api.0379.email admin.0379.email mail.0379.email wiki.0379.email;
        
        # 重定向所有请求到 HTTPS
        location / {
            return 301 https://$server_name$request_uri;
        }
    }

    # 主站点 HTTPS
    server {
        listen 8443 ssl;
        server_name 0379.email;

        # SSL 证书配置
        ssl_certificate /Users/yanyu/www/ssl-certs/live/0379.email/fullchain.pem;
        ssl_certificate_key /Users/yanyu/www/ssl-certs/live/0379.email/privkey.pem;
        
        # 安全头
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header X-Frame-Options SAMEORIGIN always;

        # 根目录
        root /Users/yanyu/www/static;
        index index.html;

        # 静态文件缓存
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        # 主页面
        location / {
            try_files $uri $uri/ /index.html;
        }

        # 健康检查
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }

    # API 服务 HTTPS
    server {
        listen 8443 ssl;
        server_name api.0379.email;

        # SSL 证书配置
        ssl_certificate /Users/yanyu/www/ssl-certs/live/api.0379.email/fullchain.pem;
        ssl_certificate_key /Users/yanyu/www/ssl-certs/live/api.0379.email/privkey.pem;
        
        # 安全头
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

        # API 响应 (测试用)
        location / {
            add_header Content-Type application/json;
            return 200 '{"status": "ok", "service": "api", "message": "0379.email API Service", "timestamp": "$time_iso8601"}';
        }

        # 健康检查
        location /health {
            access_log off;
            return 200 "API Healthy\n";
            add_header Content-Type text/plain;
        }
    }

    # 管理面板 HTTPS
    server {
        listen 8443 ssl;
        server_name admin.0379.email;

        # SSL 证书配置
        ssl_certificate /Users/yanyu/www/ssl-certs/live/admin.0379.email/fullchain.pem;
        ssl_certificate_key /Users/yanyu/www/ssl-certs/live/admin.0379.email/privkey.pem;
        
        # 安全头
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

        # 管理面板响应 (测试用)
        location / {
            add_header Content-Type text/html;
            return 200 '<!DOCTYPE html><html><head><title>0379.email Admin</title></head><body><h1>0379.email 管理面板</h1><p>SSL 配置成功！</p><p>服务状态: 正常运行</p></body></html>';
        }
    }

    # 邮件服务 HTTPS
    server {
        listen 8443 ssl;
        server_name mail.0379.email;

        # SSL 证书配置
        ssl_certificate /Users/yanyu/www/ssl-certs/live/mail.0379.email/fullchain.pem;
        ssl_certificate_key /Users/yanyu/www/ssl-certs/live/mail.0379.email/privkey.pem;
        
        # 安全头
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

        # 邮件服务响应 (测试用)
        location / {
            add_header Content-Type application/json;
            return 200 '{"status": "ok", "service": "mail", "message": "0379.email Mail Service", "timestamp": "$time_iso8601"}';
        }
    }

    # Wiki 服务 HTTPS
    server {
        listen 8443 ssl;
        server_name wiki.0379.email;

        # SSL 证书配置
        ssl_certificate /Users/yanyu/www/ssl-certs/live/wiki.0379.email/fullchain.pem;
        ssl_certificate_key /Users/yanyu/www/ssl-certs/live/wiki.0379.email/privkey.pem;
        
        # 安全头
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

        # Wiki 服务响应 (测试用)
        location / {
            add_header Content-Type text/html;
            return 200 '<!DOCTYPE html><html><head><title>0379.email Wiki</title></head><body><h1>0379.email Wiki 系统</h1><p>SSL 配置成功！</p><p>Wiki 服务正在运行</p></body></html>';
        }
    }
}
