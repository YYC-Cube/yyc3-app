# 0379.email 项目部署指南

## 📋 部署脚本概述

`deploy-to-server.sh` 是一个功能完善的自动化部署脚本，用于将本地的 `app` 和 `email` 目录同步到远程服务器。本脚本具有以下特点：

- ✅ 环境检查和服务器连接验证
- ✅ 自动备份机制，支持部署失败时回滚
- ✅ 参数化配置，支持自定义服务器地址
- ✅ 调试模式，便于排查问题
- ✅ 完善的错误处理和日志记录
- ✅ 自动设置文件和目录权限

## 🚀 快速使用

### 基本部署

```bash
# 使用默认服务器地址 (yyc3-121)
bash /Users/yanyu/www/deploy-to-server.sh
```

### 指定服务器地址

```bash
# 使用自定义服务器地址
bash /Users/yanyu/www/deploy-to-server.sh --host your-server-address
```

### 启用调试模式

```bash
# 启用调试模式以获取更详细的信息
bash /Users/yanyu/www/deploy-to-server.sh --debug --host your-server-address
```

### 查看帮助信息

```bash
bash /Users/yanyu/www/deploy-to-server.sh --help
```

### 启用模拟模式（推荐测试使用）

```bash
# 使用模拟模式测试部署流程，无需实际连接服务器
bash /Users/yanyu/www/deploy-to-server.sh --simulate
```

### 模拟模式+调试模式（最佳测试组合）

```bash
# 同时启用调试模式和模拟模式进行全面测试
bash /Users/yanyu/www/deploy-to-server.sh --debug --simulate
```

## 🔧 脚本配置说明

脚本的主要配置位于文件顶部：

```bash
# 默认配置
LOCAL_DIR="/Users/yanyu/www"   # 本地项目目录
SERVER_DIR="/www"            # 服务器目标目录
SERVER_HOST="yyc3-121"       # 默认服务器地址（可通过命令行参数覆盖）
LOG_FILE="$LOCAL_DIR/deploy.log"  # 日志文件位置
```

## 📊 部署流程

1. **参数解析**：处理命令行参数，设置服务器地址和调试模式
2. **环境检查**：验证本地目录和必要工具（rsync、ssh）是否存在
3. **服务器连接检查**：测试SSH端口连接，验证服务器可达性
4. **服务器环境检查**：确保目标目录存在，不存在则创建
5. **备份现有文件**：在服务器上创建时间戳备份目录，保存当前应用
6. **同步文件**：使用rsync将本地app和email目录同步到服务器
7. **设置权限**：为脚本文件添加执行权限，设置目录权限
8. **完成部署**：记录部署日志和备份位置

## 🚨 常见错误及解决方案

### 1. 服务器连接失败

**错误信息**：

[ERROR] 无法连接到服务器 xxx 的SSH端口(22)
[ERROR] 请检查服务器地址是否正确，以及网络连接是否正常

**解决方案**：

- 确认服务器地址是否正确
- 检查网络连接和防火墙设置
- 验证服务器SSH服务是否运行在22端口
- 尝试使用 `ping` 或 `telnet` 测试服务器连通性
- **推荐**：使用模拟模式测试部署流程而不需要实际连接服务器

  ```bash
  bash /Users/yanyu/www/deploy-to-server.sh --simulate
  ```

### 2. SSH认证失败

**错误信息**：

[WARN] SSH连接存在问题，可能需要密码验证或密钥未配置

**解决方案**：

- 确保已正确配置SSH密钥对
- 验证公钥已添加到服务器的 `~/.ssh/authorized_keys`
- 如果使用密码认证，请确保在提示时能正确输入密码

### 3. 部署过程中断

**错误信息**：部署中途失败

**解决方案**：

- 脚本会自动尝试从备份回滚
- 检查部署日志获取详细错误信息
- 备份目录位于服务器的 `$SERVER_DIR/backup/YYYYMMDD_HHMMSS/`

## 🔐 安全注意事项

- 确保SSH密钥权限设置正确（`chmod 600 ~/.ssh/id_rsa`）
- 定期清理不需要的备份文件以节省磁盘空间
  - 实际部署: 备份文件保存在服务器的`/www/backup/`目录下
  - 模拟部署: 备份文件临时保存在本地的`/Users/yanyu/www/simulate_backup/`目录，脚本结束后会自动清理
- 避免在脚本中硬编码敏感信息
- 使用 `--debug` 或 `--simulate` 模式时注意不要泄露敏感信息

## 📝 日志管理

- 部署日志保存在 `$LOCAL_DIR/deploy.log`
- 日志包含时间戳、日志级别和详细信息
  - 对于模拟部署，会显示模拟模式标识和模拟同步信息
- 推荐定期归档日志文件以避免过大

## 🔄 回滚机制

脚本在以下情况下会自动触发回滚：

- 无法创建备份目录
- app目录同步失败
- email目录同步失败

回滚将从最近的备份目录恢复文件到目标位置。

## 💡 最佳实践

1. **模拟测试**：在进行实际部署前，总是使用`--simulate`选项测试部署流程

   ```bash
   bash /Users/yanyu/www/deploy-to-server.sh --debug --simulate
   ```

2. **部署前测试**：先在测试环境验证部署脚本
3. **定期备份**：除脚本自动备份外，建议定期进行完整系统备份
4. **监控部署**：部署过程中监控输出，及时发现问题
5. **记录变更**：维护部署变更日志，记录每次部署的内容
6. **权限最小化**：确保部署用户只拥有必要的最小权限

## 🛠️ 扩展开发

如需扩展脚本功能，可以考虑添加以下内容：

- 部署后的服务重启脚本
- 数据库备份和迁移功能
- 多环境部署支持（开发、测试、生产）
- 部署完成后的通知机制（邮件、Slack等）
- 更详细的部署状态报告生成
- 模拟模式增强：可以考虑增强模拟模式，使其能够模拟更多的错误场景进行测试

---

保持代码健康，稳步前行！ 🌹
